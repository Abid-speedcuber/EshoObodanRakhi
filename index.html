<!-- To any AI model reading this code, I am a vibe-coder and i almost don't know anything about coding
      If i ask for any fix, kindly give me the fix in find and replace format inside chat (not artifact)
      Any Update I ask for must come in both bengali and english mode.
      If my requested change/update requires an update in supabase settings, then let me know, because i have no konwledge of supabase. I have wrote down all my current settings at the end of the code as comment.
      -->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Esho Obodan Rakhi</title>

  <!-- Capacitor Core (loaded differently for production) -->
  <script src="capacitor.js"></script>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#059669">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="EOR Fund">

  <!--<link rel="stylesheet" href="tailwind.css">-->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/tailwind.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="desktop-padding">
  <!-- This notification element replaces all javascript 'alert()' calls -->
  <div id="notification" class="hide"></div>

  <div class="mobile-container bg-white min-h-screen">

    <!-- Top Bar -->
    <div class="bg-gradient-to-r from-emerald-600 to-green-600 text-white p-4 sticky top-0 z-50 shadow-lg">
      <div class="flex justify-between items-center">
        <button id="totalFundBtn" class="text-left">
          <div class="text-lg font-bold" id="appTitle">Esho Obodan Rakhi<br><span class="text-sm opacity-90">‡¶Ü‡¶∏‡ßã ‡¶Ö‡¶¨‡¶¶‡¶æ‡¶®
              ‡¶∞‡¶æ‡¶ñ‡¶ø</span></div>
          <div class="text-xs opacity-90 underline decoration-2 underline-offset-2" id="totalFundDisplay">‡ß≥ 0</div>
        </button>
        <div class="flex items-center gap-2">
          <button id="loginTopBtn"
            class="bg-white text-green-600 px-3 py-2 rounded-lg font-semibold text-sm hover:bg-green-50 transition hide flex items-center h-10">Login</button>          
          <button id="userMenuBtn"
            class="bg-white text-green-600 px-3 py-2 rounded-lg font-semibold text-sm hover:bg-green-50 transition hide flex items-center h-10">Menu</button>
          <button id="adminMenuBtn"
            class="bg-white text-green-600 px-3 py-2 rounded-lg font-semibold text-sm hover:bg-green-50 transition hide flex items-center h-10">Admin</button>
          <button id="talibMenuBtn"
            class="bg-white text-green-600 px-3 py-2 rounded-lg font-semibold text-sm hover:bg-green-50 transition hide flex items-center h-10">Menu</button>
          <button id="refreshBtn"
            class="bg-white text-green-600 px-3 py-2 rounded-lg font-semibold text-sm hover:bg-green-50 transition flex items-center h-10"><img
              src="svgs/icon-refresh.svg"></button>
          <button id="settingsBtn"
            class="bg-white text-green-600 px-3 py-2 rounded-lg font-semibold text-sm hover:bg-green-50 transition flex items-center h-10"><img
              src="svgs/icon-settings.svg"></button>
        </div>
      </div>
    </div>

<!-- Main Navigation -->
<div class="flex gap-2 p-4 bg-green-50">
  <button data-section="fund" class="nav-btn bg-white p-4 rounded-xl shadow hover:shadow-lg transition text-center flex-1">
    <div class="text-3xl mb-1" style="justify-items: center;"><img src="svgs/icon-fund.svg" style="
      height: 45px;
      width: 45px;
      "></div>
    <div class="text-sm font-semibold text-gray-700">Fund History</div>
  </button>
  <button data-section="blood"
    class="nav-btn bg-white p-4 rounded-xl shadow hover:shadow-lg transition text-center flex-1">
    <div class="text-3xl mb-1" style="justify-items: center;"><img src="svgs/blood-donation-icon.svg"
        style="height: 45px; width: 45px;"></div>
    <div class="text-sm font-semibold text-gray-700">Blood Donors</div>
  </button>
  <button data-section="notices"
    class="nav-btn bg-white p-4 rounded-xl shadow hover:shadow-lg transition text-center flex-0 hide">
    <div class="text-3xl mb-1" style="justify-items: center;"><img src="svgs/announcement-icon.svg"
        style="height: 45px; width: 45px;"></div>
    <div class="text-sm font-semibold text-gray-700">Activities</div>
  </button>
</div>

    <!-- Main content area where sections will be displayed -->
    <main id="mainContent" class="p-4">
      <!-- Fund History Section -->
      <div id="fundSection" class="section hide">
        <!-- Fund Tabs (Non-Admin Only) -->
        <div id="fundTabs" class="grid grid-cols-2 gap-2 p-4 bg-green-50 hide">
          <button id="collectionTabBtn"
            class="fund-tab-btn bg-white p-3 rounded-xl shadow hover:shadow-lg transition text-center">
            <div class="text-sm font-semibold text-gray-700">Collection</div>
            <div class="text-xs text-green-700 font-bold mt-1" id="collectionTabTotal">‡ß≥ 0</div>
            <div class="text-xs text-gray-500" id="collectionTabMonth">‡ß≥ 0 this month</div>
          </button>
<button id="sadakahTabBtn"
  class="fund-tab-btn bg-white p-3 rounded-xl shadow hover:shadow-lg transition text-center">
  <div class="text-sm font-semibold text-gray-700">Sadakah</div>
  <div class="text-xs text-red-700 font-bold mt-1" id="sadakahTabTotal">‡ß≥ 0</div>
  <div class="text-xs text-gray-500" id="sadakahTabCount">‡ß≥ 0 from fund</div>
</button>
        </div>

        <!-- Collection View (default for non-admin) -->
        <div id="collectionView">
          <div class="bg-white rounded-xl shadow-lg p-3 mb-3">
            <div class="flex justify-between items-center mb-2">
              <button id="prevMonthBtn" class="bg-white text-green-700 px-2 py-1 rounded-lg font-semibold"><img
                  src="svgs/icon-previous.svg"></button>
              <h2 id="currentMonthDisplay" class="text-base font-bold text-gray-800"></h2>
              <button id="nextMonthBtn" class="bg-white text-green-700 px-2 py-1 rounded-lg font-semibold"><img
                  src="svgs/icon-next.svg"></button>
            </div>
            <div id="adminControls" class="hide mb-2 text-center">
              <button data-modal="addIncomeModal" class="bg-green-600 text-white px-4 py-2 rounded-lg mr-2 text-sm"
                id="addIncomeBtn">+Collection</button>
              <button data-modal="addExpenseModal" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm"
                id="addExpenseBtn">+Sadakah</button>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-lg font-bold text-green-700">Collection</h3>
              <button id="copyIncomeBtn"
                class="bg-green-100 text-green-700 px-3 py-2 rounded-lg text-sm font-semibold hover:bg-green-200 transition">
                <img src="svgs/icon-copy.svg"> Copy List
              </button>
            </div>
            <div class="mb-3 pb-3 border-b border-gray-200">
              <div class="text-sm text-gray-700">
                <div id="donationInfoText" class="font-semibold mb-2">You can also contribute by donating to:</div>
                <div class="space-y-1">
                  <div class="cursor-pointer hover:text-green-600 transition" data-copy-number="+880 1937-222273"><span
                      class="underline">+880 1937-222273</span> - nogod</div>
                  <div class="cursor-pointer hover:text-green-600 transition" data-copy-number="+880 1515-214867"><span
                      class="underline">+880 1515-214867</span> - bkash</div>
                </div>
              </div>
            </div>
            <div id="incomeList" class="space-y-2"></div>
            <div class="mt-3 pt-3 border-t border-gray-200">
              <div class="flex justify-between font-bold text-green-700">
                <span>Total Collection:</span>
                <span id="totalIncome">‡ß≥ 0</span>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
            <h3 class="text-lg font-bold text-red-700 mb-3">Sadakah</h3>
            <div id="expenseList" class="space-y-2"></div>
            <div class="mt-3 pt-3 border-t border-gray-200">
              <div class="flex justify-between font-bold text-red-700">
                <span>Total Sadakah:</span>
                <span id="totalExpense">‡ß≥ 0</span>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
            <div class="flex justify-between items-center mb-3">
              <span class="font-bold text-gray-700">Monthly economy:</span>
              <span id="monthlyBalance" class="text-xl font-bold">‡ß≥ 0</span>
            </div>
            <div class="flex justify-between items-center pt-3 border-t border-gray-200">
              <span class="font-bold text-blue-700">Net worth at month end:</span>
              <span id="netWorth" class="text-xl font-bold text-blue-700">‡ß≥ 0</span>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-lg p-4 text-center" style="justify-items:center;">
            <button id="showYearlyChartBtn"
              class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2">
              <img src="svgs/overview-icon.svg" style="width: 20px; height: 20px;"> View Yearly Overview
            </button>
          </div>
        </div>

        <!-- Sadakah List View (Non-Admin Only) -->
        <div id="sadakahListView" class="hide">
          <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
            <h3 class="text-lg font-bold text-red-700 mb-3">All Sadakah History</h3>
            <div id="allSadakahList" class="space-y-3"></div>
            <div class="mt-4 pt-4 border-t border-gray-200">
              <div class="text-sm text-gray-700">
                <div id="sadakahDonationInfoText" class="font-semibold mb-2">You can also contribute by donating to:
                </div>
                <div class="space-y-1">
                  <div class="cursor-pointer hover:text-green-600 transition" data-copy-number="+880 1937-222273"><span
                      class="underline">+880 1937-222273</span> - nogod</div>
                  <div class="cursor-pointer hover:text-green-600 transition" data-copy-number="+880 1515-214867"><span
                      class="underline">+880 1515-214867</span> - bkash</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Blood Donors Section -->
      <div id="bloodSection" class="section hide">
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Blood Donors</h2>
            <button id="myDonorBtn" class="bg-green-600 text-white px-3 py-2 rounded-lg text-sm hide">My
              Profile</button>
          </div>
          <div id="donorPromptMessage"
            class="hide bg-blue-50 border-l-4 border-blue-500 p-3 text-sm text-blue-800 mb-4">
            To be a blood donor, click on "My Profile" and add your phone number and location.
          </div>
        </div>
        <div id="bloodFilterContainer" class="bg-white rounded-xl shadow-lg p-4 mb-4">
          <div class="flex items-center gap-2">
            <select id="bloodFilter" class="flex-1 p-3 border border-gray-300 rounded-lg">
              <option value="all">All Blood Groups</option>
              <option value="A+">A+</option>
              <option value="A-">A-</option>
              <option value="B+">B+</option>
              <option value="B-">B-</option>
              <option value="O+">O+</option>
              <option value="O-">O-</option>
              <option value="AB+">AB+</option>
              <option value="AB-">AB-</option>
            </select>
            <input type="text" id="bloodSearch" placeholder="Search donors..."
              class="hide flex-1 p-3 border border-gray-300 rounded-lg">
            <button id="bloodSearchBtn"
              class="bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition flex-shrink-0">
              <img src="svgs/icon-search.svg" alt="Search" style="width: 20px; height: 20px;">
            </button>
            <button id="bloodClearBtn"
              class="hide bg-white text-white p-3 rounded-lg hover:bg-gray-100 transition flex-shrink-0">
              <img src="svgs/icon-close.svg" alt="Clear" style="width: 20px; height: 20px;">
            </button>
          </div>
        </div>
        <div id="donorsList" class="space-y-3"></div>
      </div>

      <!-- Notices Section -->
      <div id="noticesSection" class="section hide">
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
          <h2 class="text-xl font-bold text-gray-800 mb-3">Fund Activities</h2>
          <button id="postNoticeBtn" data-modal="postNoticeModal"
            class="bg-green-600 text-white px-4 py-2 rounded-lg w-full hide">Post Activity</button>
        </div>
        <div id="noticesList" class="space-y-4"></div>
      </div>

      <!-- Notifications Section -->
      <div id="notificationsSection" class="section hide">
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
          <div class="flex justify-between items-center mb-3">
            <h2 class="text-xl font-bold text-gray-800">Notifications</h2>
            <button id="createNotificationBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700 transition hide">
              + New Notification
            </button>
          </div>
        </div>
        <div id="notificationsList" class="space-y-3"></div>
      </div>

      <!-- User Messages Section (for regular users) -->
      <div id="userMessagesSection" class="section hide">
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
          <div class="flex justify-between items-center mb-3">
            <h2 class="text-xl font-bold text-gray-800">My Messages</h2>
            <button id="composeNewMessageBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700 transition">
              ‚úâÔ∏è New Message
            </button>
          </div>
          <div id="messageCooldownWarning" class="hide bg-yellow-50 border-l-4 border-yellow-500 p-3 text-sm text-yellow-800 mt-3">
            <span id="cooldownText"></span>
          </div>
        </div>
        <div id="userMessagesList" class="space-y-3"></div>
      </div>

      <!-- Admin Messages Section -->
      <div id="adminMessagesSection" class="section hide">
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
          <h2 class="text-xl font-bold text-gray-800 mb-3">User Messages</h2>
          <div class="flex gap-2">
            <button class="admin-message-tab bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition flex-1" data-tab="unread">
              Unread
            </button>
            <button class="admin-message-tab bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition flex-1 border border-blue-600" data-tab="read">
              Read
            </button>
            <button class="admin-message-tab bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition flex-1 border border-blue-600" data-tab="replied">
              Replied
            </button>
          </div>
        </div>
        <div id="adminMessagesList" class="space-y-3"></div>
      </div>

<!-- Notes Section -->
<div id="notesSection" class="section hide">
  <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
    <div class="flex justify-between items-center mb-3">
      <div class="flex items-center gap-2">
        <h2 class="text-xl font-bold text-gray-800">Notes</h2>
        <button id="notesFormattingGuideBtn" class="bg-gray-200 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold hover:bg-gray-300 transition" title="Formatting Guide">
          <span class="text-gray-600">i</span>
        </button>
      </div>
      <div class="flex gap-2">
        <button id="createBackupBtn" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition hide" title="Backup to Cloud">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
        </button>
        <button id="exportNotesBtn" class="bg-purple-600 text-white p-2 rounded-lg hover:bg-purple-700 transition" title="Export to File">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        </button>
        <button id="importNotesBtn" class="bg-orange-600 text-white p-2 rounded-lg hover:bg-orange-700 transition" title="Import from File">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        </button>
        <input type="file" id="importNotesFile" accept=".json" class="hide">
        <button id="createNoteBtn" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition" title="New Note">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
      </div>
    </div>

    <div id="notesLastSync" class="text-xs text-gray-500 text-center"></div>
  </div>

  <div id="notesList" class="space-y-3"></div>
</div>
    </main>

    <!-- All Modals -->
    <div id="loginModal" class="modal hide">
      <div class="modal-content">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Login</h2>
        <form id="loginForm">
          <input type="email" id="loginEmail" placeholder="Email" class="modal-input" required>
          <div class="relative mb-4">
            <input type="password" id="loginPassword" placeholder="Password" class="modal-input mb-0" required>
            <button type="button" id="toggleLoginPassword"
              class="absolute right-3 top-3 text-gray-500 hover:text-gray-700">
              <img src="svgs/icon-eye.svg" id="loginEyeIcon" style="width: 20px; height: 20px;" alt="Show password">
            </button>
          </div>
          <button id="forgotPasswordBtn" type="button"
            class="w-full text-right text-orange-600 font-semibold text-sm mb-3">Forgot Password?</button>
          <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold mb-4">Login</button>
        </form>

        <!-- OR Divider -->
        <div class="flex items-center gap-3 mb-4">
          <div class="flex-1 h-px bg-gray-300"></div>
          <span class="text-gray-500 text-sm">or</span>
          <div class="flex-1 h-px bg-gray-300"></div>
        </div>

        <!-- START: Continue with Google button -->
        <button id="googleLoginBtn" type="button"
          class="w-full bg-white border border-gray-300 py-3 rounded-lg font-semibold mb-4 flex items-center justify-center gap-3 hover:bg-gray-50 transition">
          <img src="svgs/icon-google.svg" alt="G" style="width:18px;height:18px;">
          <span>Continue with Google</span>
        </button>
        <!-- END: Continue with Google button -->

        <button id="showSignupBtn" class="w-full text-blue-600 py-2 font-semibold">Don't have an account? Sign
          up</button>
        <button data-close-modal class="w-full mt-2 text-gray-600 py-2">Cancel</button>
      </div>
    </div>

    <div id="signupModal" class="modal hide">
      <div class="modal-content">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Sign Up</h2>
        <form id="signupForm">
          <input type="text" id="signupName" placeholder="Full Name" class="modal-input" required>
          <input type="email" id="signupEmail" placeholder="Email" class="modal-input" required>
          <div class="relative mb-3">
            <input type="password" id="signupPassword" placeholder="Password" class="modal-input mb-0" required>
            <button type="button" id="toggleSignupPassword"
              class="absolute right-3 top-3 text-gray-500 hover:text-gray-700">
              <img src="svgs/icon-eye.svg" id="signupEyeIcon" style="width: 20px; height: 20px;" alt="Show password">
            </button>
          </div>
          <div class="relative mb-4">
            <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" class="modal-input mb-0"
              required>
            <button type="button" id="toggleSignupConfirmPassword"
              class="absolute right-3 top-3 text-gray-500 hover:text-gray-700">
              <img src="svgs/icon-eye.svg" id="signupConfirmEyeIcon" style="width: 20px; height: 20px;"
                alt="Show password">
            </button>
          </div>
          <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold mb-3">Sign
            Up</button>
        </form>
        <button id="showLoginBtn" class="w-full text-green-600 py-2 font-semibold">Already have an account?
          Login</button>
        <button data-close-modal class="w-full mt-2 text-gray-600 py-2">Cancel</button>
      </div>
    </div>

    <div id="forgotPasswordModal" class="modal hide">
      <div class="modal-content">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Forgot Password</h2>
        <p class="text-sm text-gray-600 mb-4">Enter your email address and we'll send you a password reset link.</p>
        <form id="forgotPasswordForm">
          <input type="email" id="forgotEmail" placeholder="Email" class="modal-input mb-4" required>
          <button type="submit" class="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold mb-3">Send Reset
            Link</button>
        </form>
        <button id="backToLoginBtn" class="w-full text-green-600 py-2 font-semibold">Back to Login</button>
        <button data-close-modal class="w-full mt-2 text-gray-600 py-2">Cancel</button>
      </div>
    </div>

    <div id="addIncomeModal" class="modal hide">
      <div class="modal-content">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Add Collection</h2>
        <form id="addIncomeForm">
          <input type="hidden" id="incomeId">
          <input type="text" id="incomeName" placeholder="Donor Name" class="modal-input" required>
          <input type="number" id="incomeAmount" placeholder="Amount (‡ß≥)" class="modal-input" required>
          <label class="flex items-center mb-4 cursor-pointer">
            <input type="checkbox" id="incomeHighlighted" class="mr-2 w-5 h-5">
            <span class="text-gray-700">Highlight this entry</span>
          </label>
          <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold">Add</button>
            <button type="button" data-close-modal
              class="flex-1 bg-gray-400 text-white py-3 rounded-lg font-semibold">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <div id="addExpenseModal" class="modal hide">
      <div class="modal-content">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Add Sadakah</h2>
        <form id="addExpenseForm">
          <input type="hidden" id="expenseId">
          <input type="text" id="expenseDesc" placeholder="Title" class="modal-input" required>
          <input type="number" id="expenseAmount" placeholder="Amount (‡ß≥)" class="modal-input" required>
          <textarea id="expenseAdditionalInfo" placeholder="Additional info (optional)"
            class="modal-input h-24"></textarea>
<div class="mb-4">
  <button type="button" id="advancedOptionsToggle" class="text-sm text-blue-600 hover:text-blue-700 font-semibold flex items-center gap-1">
    <span>Advanced Options</span>
    <span id="advancedArrow">‚ñº</span>
  </button>
  <div id="advancedOptions" class="mt-3 p-3 bg-gray-50 rounded-lg hide" style="display: none;">
  <div class="space-y-3">
    <div class="flex items-center justify-between">
      <span class="text-sm text-gray-700">Highlight</span>
      <label class="switch">
        <input type="checkbox" id="expenseHighlighted">
        <span class="slider"></span>
      </label>
    </div>
    <div class="flex items-center justify-between">
      <span class="text-sm text-gray-700">Show in Sadakah Tab</span>
      <label class="switch">
        <input type="checkbox" id="expenseDisplay" checked>
        <span class="slider"></span>
      </label>
    </div>
    <div class="flex items-center justify-between">
      <span class="text-sm text-gray-700">Include in Calculations</span>
      <label class="switch">
        <input type="checkbox" id="expenseCalculation" checked>
        <span class="slider"></span>
      </label>
    </div>
  </div>
</div>
</div>
          <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-red-600 text-white py-3 rounded-lg font-semibold">Add</button>
            <button type="button" data-close-modal
              class="flex-1 bg-gray-400 text-white py-3 rounded-lg font-semibold">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <div id="donorProfileModal" class="modal hide">
      <div class="modal-content">
        <h2 class="text-xl font-bold mb-4 text-gray-800">My Donor Profile</h2>
        <form id="donorProfileForm">
          <input type="hidden" id="donorId">
          <input type="text" id="donorName" placeholder="Full Name" class="modal-input" required>
          <input type="tel" id="donorPhone" placeholder="Phone Number" class="modal-input" required>
          <select id="donorBloodGroup" class="modal-input" required>
            <option value="" disabled selected>Select Blood Group</option>
            <option value="A+">A+</option>
            <option value="A-">A-</option>
            <option value="B+">B+</option>
            <option value="B-">B-</option>
            <option value="O+">O+</option>
            <option value="O-">O-</option>
            <option value="AB+">AB+</option>
            <option value="AB-">AB-</option>
          </select>
          <input type="text" id="donorLocation" placeholder="Location" class="modal-input" required>
          <label class="flex items-center mb-4 cursor-pointer">
            <input type="checkbox" id="donorAvailable" class="mr-2 w-5 h-5">
            <span class="text-gray-700">Available to donate</span>
          </label>
          <div class="mb-4">
            <label class="flex items-center mb-2 cursor-pointer">
              <input type="checkbox" id="donorHasLastDonated" class="mr-2 w-5 h-5">
              <span class="text-gray-700">Has donated before</span>
            </label>
            <input type="date" id="donorLastDonated" class="modal-input hide" placeholder="Last donation date">
          </div>
          <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold">Save</button>
            <button type="button" id="deleteDonorBtn"
              class="bg-red-600 text-white px-4 py-3 rounded-lg font-semibold hide">Delete</button>
          </div>
          <button type="button" data-close-modal class="w-full mt-3 text-gray-600 py-2">Cancel</button>
        </form>
      </div>
    </div>

    <div id="postNoticeModal" class="modal hide">
      <div class="modal-content">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Post Activity</h2>
        <form id="postNoticeForm">
          <input type="hidden" id="noticeId">
          <textarea id="noticeText" placeholder="What's happening?" class="modal-input h-32" required></textarea>
          <div class="flex gap-2 mt-4">
            <button type="submit" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold">Post</button>
            <button type="button" data-close-modal
              class="flex-1 bg-gray-400 text-white py-3 rounded-lg font-semibold">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <div id="yearlyChartModal" class="modal hide">
      <div class="modal-content" style="max-width: 480px; max-height: 90vh; overflow-y: auto;">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Yearly Overview</h2>
        <div class="flex justify-between items-center mb-3">
          <button id="prevYearBtn"
            class="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg text-sm font-semibold">‚Üê</button>
          <h3 class="text-lg font-bold text-gray-800"><span id="currentYearDisplay"></span></h3>
          <button id="nextYearBtn"
            class="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg text-sm font-semibold">‚Üí</button>
        </div>
        <canvas id="yearlyChart" width="1000" height="1000" class="w-full"></canvas>
        <div class="flex justify-center gap-6 mt-3 text-sm">
          <div class="flex items-center">
            <div class="w-4 h-4 bg-green-500 rounded mr-2"></div><span>Collection</span>
          </div>
          <div class="flex items-center">
            <div class="w-4 h-4 bg-red-500 rounded mr-2"></div><span>Sadakah</span>
          </div>
          <div class="flex items-center">
            <div class="w-4 h-4 bg-blue-500 rounded mr-2"></div><span>Total Fund</span>
          </div>
        </div>
        <button type="button" data-close-modal
          class="w-full mt-4 bg-gray-400 text-white py-3 rounded-lg font-semibold">Close</button>
      </div>
    </div>

    <div id="completeHistoryModal" class="modal hide">
      <div class="modal-content" style="max-width: 480px; max-height: 90vh; overflow-y: auto;">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-800">‡¶´‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶§‡¶•‡ßç‡¶Ø</h2>
          <button id="copyHistoryBtn"
            class="bg-green-400 text-black px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-500 transition flex items-center gap-1">
            <img src="svgs/icon-copy.svg"> Copy
          </button>
        </div>
        <div class="flex items-center justify-between mb-3 bg-gray-100 p-3 rounded-lg">
          <span class="text-sm font-semibold text-gray-700">History Mode:</span>
          <button id="historyModeToggle"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition">
            Yearly Brief
          </button>
        </div>
        <div id="completeHistoryContent" class="text-sm text-gray-700 space-y-2 mb-4"></div>
        <button type="button" data-close-modal
          class="w-full bg-gray-400 text-white py-3 rounded-lg font-semibold">Close</button>
      </div>
    </div>

  </div>

  <!-- User Menu Modal -->
  <div id="userMenuModal" class="modal hide">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Menu</h2>
      <div class="space-y-2">
        <button id="userNotesBtn"
          class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition text-left px-4">
          üìù Notes
        </button>
        <button id="userNotificationsBtn"
          class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition text-left px-4">
          üîî Notifications
        </button>
        <button id="messageAdminBtn"
          class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition text-left px-4 relative">
          üí¨ Message Admin
          <span id="messageAdminBadge" class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full hide"></span>
        </button>
      </div>
      <button data-close-modal class="w-full mt-4 bg-gray-400 text-white py-3 rounded-lg font-semibold">Close</button>
    </div>
  </div>

  <!-- Talib Menu Modal -->
  <div id="talibMenuModal" class="modal hide">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Menu</h2>
      <div class="space-y-2">
        <button id="talibNotesBtn"
          class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition text-left px-4">
          üìù Notes
        </button>
        <button id="talibNotificationsBtn"
          class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition text-left px-4">
          üîî Notifications
        </button>
        <button id="talibMessageAdminBtn"
          class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition text-left px-4 relative">
          üí¨ Message Admin
          <span id="talibMessageAdminBadge" class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full hide"></span>
        </button>
      </div>
      <button data-close-modal class="w-full mt-4 bg-gray-400 text-white py-3 rounded-lg font-semibold">Close</button>
    </div>
  </div>

  <!-- Admin Menu Modal -->
  <div id="adminMenuModal" class="modal hide">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Admin Menu</h2>
      <div class="space-y-2">
        <button id="adminUsersBtn"
          class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition text-left px-4">
          üë• Users
        </button>
        <button id="adminNotesBtn"
          class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition text-left px-4">
          üìù Notes
        </button>
        <button id="adminNotificationsBtn"
          class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition text-left px-4">
          üîî Notifications
        </button>
        <button id="adminMessagesBtn"
          class="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold hover:bg-orange-700 transition text-left px-4 relative">
          üí¨ User Messages
          <span id="userMessagesBadge" class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full hide"></span>
        </button>
      </div>
      <button data-close-modal class="w-full mt-4 bg-gray-400 text-white py-3 rounded-lg font-semibold">Close</button>
    </div>
  </div>

  <!-- Admin Users Modal -->
  <div id="adminUsersModal" class="modal hide">
    <div class="modal-content" style="max-width: 480px; max-height: 90vh; overflow-y: auto;">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Manage Users</h2>
      <div class="mb-4">
        <div class="flex items-center gap-2">
          <input type="text" id="userSearch" placeholder="Search users..."
            class="flex-1 p-3 border border-gray-300 rounded-lg">
          <button id="userClearBtn"
            class="hide bg-white text-white p-3 rounded-lg hover:bg-gray-100 transition flex-shrink-0">
            <img src="svgs/icon-close.svg" alt="Clear" style="width: 20px; height: 20px;">
          </button>
        </div>
      </div>
      <div id="usersList" class="space-y-2 mb-4"></div>
      <button data-close-modal class="w-full bg-gray-400 text-white py-3 rounded-lg font-semibold">Close</button>
    </div>
  </div>

  <!-- Role Change Confirmation Modal -->
  <div id="roleConfirmModal" class="modal hide">
    <div class="modal-content" style="max-width: 500px;">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Confirm Role Change</h2>
      <p class="text-gray-700 mb-4">Are you sure you want to change this user's role?</p>
      <div class="flex gap-2">
        <button id="roleConfirmYes"
          class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">Yes,
          Continue</button>
        <button id="roleConfirmNo"
          class="flex-1 bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500 transition">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Role Change Consequences Modal -->
  <div id="roleConsequencesModal" class="modal hide">
    <div class="modal-content" style="max-width: 500px;">
      <h2 class="text-xl font-bold mb-4 text-red-600">‚ö†Ô∏è Important: Understand the Consequences</h2>
      <div id="roleConsequencesText" class="text-gray-700 mb-4 space-y-2"></div>
      <div class="flex gap-2">
        <button id="roleConsequencesConfirm"
          class="flex-1 bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition">I Understand,
          Proceed</button>
        <button id="roleConsequencesCancel"
          class="flex-1 bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500 transition">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Note View Modal (Read-only) -->
  <div id="noteViewModal" class="modal hide">
    <div class="modal-content" style="max-width: 480px; max-height: 90vh; overflow-y: auto;">
      <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
        <div>
          <h2 id="noteViewTitle" class="text-xl font-bold text-gray-800"></h2>
          <div id="noteViewDate" class="text-sm text-gray-500 mt-1"></div>
        </div>
        <div class="flex gap-2">
          <button id="editNoteBtn" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition">
            <img src="svgs/icon-edit.svg" style="width: 20px; height: 20px;">
          </button>
          <button id="deleteNoteViewBtn" class="bg-red-600 text-white p-2 rounded-lg hover:bg-red-700 transition">
            <img src="svgs/icon-delete.svg" style="width: 20px; height: 20px;">
          </button>
        </div>
      </div>
      <div id="noteViewContent" class="text-gray-700 whitespace-pre-wrap"></div>
      <button data-close-modal class="w-full mt-4 bg-gray-400 text-white py-3 rounded-lg font-semibold">Close</button>
    </div>
  </div>

  <!-- Note Edit Modal -->
  <div id="noteEditModal" class="modal hide">
    <div class="modal-content" style="max-width: 480px; max-height: 90vh; overflow-y: auto;">
      <!-- Editable Title and Date Bar -->
      <div class="flex justify-between items-center px-4 py-3 border-b border-gray-200 bg-gray-50">
        <div class="flex-1">
          <input type="text" id="noteTitleInput" placeholder="Untitled" class="text-xl font-bold text-gray-800 bg-transparent border-none outline-none w-full focus:bg-white focus:px-2 focus:py-1 rounded" maxlength="100">
          <input type="date" id="noteDateInput" class="text-sm text-gray-500 mt-1 bg-transparent border-none outline-none cursor-pointer hover:bg-white hover:px-2 hover:py-1 rounded" required>
        </div>
        <div class="flex gap-2">
          <button id="saveNoteBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">Save</button>
          <button type="button" id="deleteNoteEditBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition hide">Delete</button>
        </div>
      </div>   
      
      <form id="noteEditForm">
        <input type="hidden" id="noteEditId">
        <div class="note-editor-wrapper px-4" style="position: relative;">
          <div 
            id="noteContentInput" 
            class="modal-input border border-gray-300" 
            contenteditable="true"
            placeholder="Write your note here..." 
            style="min-height: 300px; font-family: inherit; outline: none; cursor: text; white-space: pre-wrap; overflow-y: auto;" 
            required
          ></div>
        </div>
        <div class="flex gap-2 mt-4 px-4 pb-4">
          <button type="button" data-close-modal class="flex-1 bg-gray-400 text-white py-3 rounded-lg font-semibold">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create/Edit Notification Modal -->
  <div id="notificationModal" class="modal hide">
    <div class="modal-content" style="max-width: 480px;">
      <h2 class="text-xl font-bold mb-4 text-gray-800" id="notificationModalTitle">Create Notification</h2>
      <form id="notificationForm">
        <input type="hidden" id="notificationId">
        <input type="text" id="notificationTitle" placeholder="Title" class="modal-input" required>
        <textarea id="notificationContent" placeholder="Message" class="modal-input h-32" required></textarea>
        <select id="notificationTarget" class="modal-input" required>
          <option value="" disabled selected>Select Target Audience</option>
          <option value="all">All Users</option>
          <option value="student">Students Only</option>
        </select>
        <div class="flex gap-2 mt-4">
          <button type="submit" class="flex-1 bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition">Send</button>
          <button type="button" data-close-modal class="flex-1 bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500 transition">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Notes Access Denied Modal -->
  <div id="notesAccessDeniedModal" class="modal hide">
    <div class="modal-content" style="max-width: 400px;">
      <h2 class="text-xl font-bold mb-4 text-orange-600">‚ö†Ô∏è Access Restricted</h2>
<p class="text-gray-700 mb-4">
  You need at least <strong>student access</strong> to upload your notes to the cloud.  
  You can request access by sending an email to  
  <a 
    href="mailto:abidashrafkhulna@gmail.com?subject=Request%20for%20Student%20Access&body=I%20would%20like%20to%20request%20student%20access%20to%20upload%20my%20notes%20to%20the%20cloud."
    class="text-blue-600 hover:underline"
  >
    abidashrafkhulna@gmail.com
  </a>.
</p>

<p class="text-gray-700 mb-4" style="direction: rtl; text-align: right;">
  ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡ßã‡¶ü ‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶°‡ßá ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ö‡¶®‡ßç‡¶§‡¶§ <strong>‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏</strong> ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§  
  ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶® ‚Äî  
  <a 
    href="mailto:abidashrafkhulna@gmail.com?subject=‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü%20‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏%20‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü&body=I%20would%20like%20to%20request%20student%20access%20to%20upload%20my%20notes%20to%20the%20cloud."
    class="text-blue-600 hover:underline"
  >
    abidashrafkhulna@gmail.com
  </a>‡•§
</p>

      <button data-close-modal class="w-full bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500 transition">Close</button>
    </div>
  </div>

  <!-- Unsaved Changes Warning Modal -->
  <div id="unsavedChangesModal" class="modal hide">
    <div class="modal-content" style="max-width: 400px;">
      <h2 class="text-xl font-bold mb-4 text-orange-600">‚ö†Ô∏è Unsaved Changes</h2>
      <p class="text-gray-700 mb-4">You have unsaved changes. Are you sure you want to close without saving?</p>
      <div class="flex gap-2">
        <button id="discardChangesBtn" class="flex-1 bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition">Discard</button>
        <button id="keepEditingBtn" class="flex-1 bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500 transition">Keep Editing</button>
      </div>
    </div>
  </div>

  <!-- Compose Message Modal -->
  <div id="composeMessageModal" class="modal hide">
    <div class="modal-content" style="max-width: 480px;">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Message Admin</h2>
      <form id="composeMessageForm">
        <label class="block font-semibold text-gray-700 mb-2">Subject *</label>
        <select id="messageSubject" class="modal-input mb-4" required>
          <option value="" disabled selected>Select a subject</option>
          <option value="Add my donation to the list">Add my donation to the list</option>
          <option value="Remove the admin blood donor account with my name">Remove the admin blood donor account with my name</option>
          <option value="Suggest a feature">Suggest a feature</option>
          <option value="Other">Other</option>
        </select>
        
        <div id="customSubjectSection" class="hide mb-4">
          <input type="text" id="customSubject" class="modal-input" placeholder="Enter your subject">
        </div>

        <label class="block font-semibold text-gray-700 mb-2">Message (Optional)</label>
        <textarea id="messageContent" class="modal-input h-32 mb-4" placeholder="Type your message here..."></textarea>

        <div class="flex gap-2">
          <button type="submit" class="flex-1 bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition">Send</button>
          <button type="button" data-close-modal class="flex-1 bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500 transition">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View User Message Modal (for users) -->
  <div id="viewUserMessageModal" class="modal hide">
    <div class="modal-content" style="max-width: 480px; max-height: 90vh; overflow-y: auto;">
      <div class="border-b border-gray-200 pb-3 mb-3">
        <h2 id="viewMessageSubject" class="text-xl font-bold text-gray-800 mb-1"></h2>
        <div id="viewMessageTimestamp" class="text-sm text-gray-500"></div>
      </div>
      <div id="viewMessageContent" class="text-gray-700 mb-4 whitespace-pre-wrap"></div>
      <div id="viewMessageReply"></div>
      <button data-close-modal class="w-full mt-4 bg-gray-400 text-white py-3 rounded-lg font-semibold">Close</button>
    </div>
  </div>

  <!-- View Admin Message Modal (for admins) -->
  <div id="adminViewMessageModal" class="modal hide">
    <div class="modal-content" style="max-width: 480px; max-height: 90vh; overflow-y: auto;">
      <div class="border-b border-gray-200 pb-3 mb-3">
        <div class="text-sm text-gray-600 mb-1">From: <span id="adminViewMessageFrom" class="font-semibold"></span></div>
        <h2 id="adminViewMessageSubject" class="text-xl font-bold text-gray-800 mb-1"></h2>
        <div id="adminViewMessageTimestamp" class="text-sm text-gray-500"></div>
      </div>
      <div id="adminViewMessageContent" class="text-gray-700 mb-4 whitespace-pre-wrap"></div>
      <div id="adminReplySection"></div>
      <button data-close-modal class="w-full mt-4 bg-gray-400 text-white py-3 rounded-lg font-semibold">Close</button>
    </div>
  </div>

  <!-- Formatting Guide Modal -->
  <div id="formattingGuideModal" class="modal hide">
    <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Formatting Guide</h2>
      <div class="space-y-4 text-sm">
        <div class="bg-gray-50 p-3 rounded-lg">
          <p class="font-semibold mb-2">Bold Text</p>
          <p class="text-gray-600 mb-1">Wrap text with asterisks: <code class="bg-white px-2 py-1 rounded">*text*</code></p>
          <p class="text-gray-500">Example: <strong>bold text</strong></p>
        </div>
        
        <div class="bg-gray-50 p-3 rounded-lg">
          <p class="font-semibold mb-2">Italic Text</p>
          <p class="text-gray-600 mb-1">Wrap text with plus signs: <code class="bg-white px-2 py-1 rounded">+text+</code></p>
          <p class="text-gray-500">Example: <em>italic text</em></p>
        </div>
        
        <div class="bg-gray-50 p-3 rounded-lg">
          <p class="font-semibold mb-2">Underlined Text</p>
          <p class="text-gray-600 mb-1">Wrap text with underscores: <code class="bg-white px-2 py-1 rounded">_text_</code></p>
          <p class="text-gray-500">Example: <span style="text-decoration: underline;">underlined text</span></p>
        </div>
        
        <div class="bg-gray-50 p-3 rounded-lg">
          <p class="font-semibold mb-2">Red Text</p>
          <p class="text-gray-600 mb-1">Wrap text with percent signs: <code class="bg-white px-2 py-1 rounded">%text%</code></p>
          <p class="text-gray-500">Example: <span style="color: #dc2626;">red text</span></p>
        </div>
        
        <div class="bg-gray-50 p-3 rounded-lg">
          <p class="font-semibold mb-2">Numbered Lists</p>
          <p class="text-gray-600 mb-2">Start with <code class="bg-white px-2 py-1 rounded">#(num)</code> and end with <code class="bg-white px-2 py-1 rounded">#</code></p>
          <pre class="bg-white p-2 rounded text-xs mb-2">#(num)
text 1
text 2
text 3
#</pre>
          <p class="text-gray-600 mb-1">Options:</p>
          <ul class="text-xs text-gray-500 ml-4 space-y-1">
            <li><code class="bg-white px-1 rounded">t=1</code> for 1,2,3 (default)</li>
            <li><code class="bg-white px-1 rounded">t=a</code> for a,b,c</li>
            <li><code class="bg-white px-1 rounded">t=i</code> for i,ii,iii</li>
            <li><code class="bg-white px-1 rounded">t=I</code> for I,II,III</li>
            <li><code class="bg-white px-1 rounded">t=bn</code> for Bengali</li>
            <li><code class="bg-white px-1 rounded">s=3</code> to start at 3</li>
          </ul>
          <p class="text-xs text-gray-500 mt-2">Example: <code class="bg-white px-1 rounded">#(num, t=I, s=3)</code></p>
        </div>
        
        <div class="bg-gray-50 p-3 rounded-lg">
          <p class="font-semibold mb-2">Bullet Lists</p>
          <p class="text-gray-600 mb-2">Start with <code class="bg-white px-2 py-1 rounded">#(bul)</code> and end with <code class="bg-white px-2 py-1 rounded">#</code></p>
          <pre class="bg-white p-2 rounded text-xs mb-2">#(bul)
text 1
text 2
text 3
#</pre>
          <p class="text-gray-600 mb-1">Options:</p>
          <ul class="text-xs text-gray-500 ml-4 space-y-1">
            <li><code class="bg-white px-1 rounded">t=sq</code> for square ‚ñ†</li>
            <li><code class="bg-white px-1 rounded">t=di</code> for disk ‚óè (default)</li>
            <li><code class="bg-white px-1 rounded">t=ci</code> for circle ‚óã</li>
            <li><code class="bg-white px-1 rounded">t=ar</code> for arrow ‚Üí</li>
          </ul>
        </div>
      </div>
      <button data-close-modal class="w-full mt-4 bg-gray-400 text-white py-3 rounded-lg font-semibold">Close</button>
    </div>
  </div>

  <!-- About Modal -->
  <div id="aboutModal" class="modal hide">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-gray-800">About Esho Obodan Rakhi</h2>
      <p class="text-gray-700 mb-4">Placeholder content about the organization and its mission...</p>
      <button data-close-modal class="w-full bg-gray-400 text-white py-3 rounded-lg font-semibold">Close</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal hide">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Settings</h2>
      <div class="flex items-center justify-between mb-4">
        <span class="font-semibold text-gray-700">Bengali Mode</span>
        <label class="flex items-center cursor-pointer">
          <input type="checkbox" id="bengaliModeToggle" class="mr-2 w-5 h-5">
          <span class="text-gray-700">Enable</span>
        </label>
      </div>
      <button id="loginBtn"
        class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold mb-2 hide">Login</button>
      <button id="logoutBtn"
        class="w-full bg-red-600 text-white py-3 rounded-lg font-semibold mb-2 hide">Logout</button>
      <button data-close-modal class="w-full bg-gray-400 text-white py-3 rounded-lg font-semibold">Close</button>
    </div>
  </div>

  <script>
    // --- SUPABASE CONFIG (Your settings are here) ---
    const SUPABASE_URL = "https://kszhmrhlsoqfxkcopvoe.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtzemhtcmhsc29xZnhrY29wdm9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NjU5MTcsImV4cCI6MjA3NTU0MTkxN30.8TLXLfVbPiwtzpa_4wEYzC9Lfqm58Z7ICIaUQsa0izA";

    const { createClient } = supabase;

    // Check if running in Capacitor (mobile app)
    if (typeof window.Capacitor === 'undefined') {
      window.Capacitor = {
        Plugins: {},
        isNativePlatform: () => false
      };
    }
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- APPLICATION LOGIC ---
    const App = {
      // --- STATE ---
      state: {
        currentUser: null,
        userProfile: null, // { id, name, role }
        isAdmin: false,
        currentMonth: new Date(new Date().getFullYear(), new Date().getMonth(), 1), // Start at current month
        allDonors: [],
        totalFund: 0,
        activeSection: 'blood',
        activeFundTab: 'sadakah', // Default for non-admin
        currentYear: new Date().getFullYear(),
        isLoading: {
          fund: false,
          donors: false,
          notices: false,
          notes: false,
        },
        allFundData: [], // Store all fund data for offline access
        cachedMonthlyData: {}, // Store monthly aggregated data
        notes: [], // All notes in memory
        currentNote: null, // Currently viewing/editing note
        notesNeedSync: false, // Track if local notes differ from server
        notesRecycleBin: [], // Deleted notes that shouldn't come back from server
      },

      shouldFetchFreshData: true, // Flag to control when to fetch from server

      pendingRoleChange: null, // Store pending role change data for confirmation flow

      // --- DOM ELEMENTS ---
      elements: {
        notification: document.getElementById('notification'),
        authBtn: document.getElementById('authBtn'),
        adminMenuBtn: document.getElementById('adminMenuBtn'),
        totalFundDisplay: document.getElementById('totalFundDisplay'),
        fundTabs: document.getElementById('fundTabs'),
        collectionView: document.getElementById('collectionView'),
        sadakahListView: document.getElementById('sadakahListView'),
        allSadakahList: document.getElementById('allSadakahList'),
        mainContent: document.getElementById('mainContent'),
        currentMonthDisplay: document.getElementById('currentMonthDisplay'),
        incomeList: document.getElementById('incomeList'),
        expenseList: document.getElementById('expenseList'),
        totalIncome: document.getElementById('totalIncome'),
        totalExpense: document.getElementById('totalExpense'),
        monthlyBalance: document.getElementById('monthlyBalance'),
        donorsList: document.getElementById('donorsList'),
        noticesList: document.getElementById('noticesList'),
        notesList: document.getElementById('notesList'),
        adminControls: document.getElementById('adminControls'),
        myDonorBtn: document.getElementById('myDonorBtn'),
        postNoticeBtn: document.getElementById('postNoticeBtn'),
        deleteDonorBtn: document.getElementById('deleteDonorBtn'),
        yearlyChart: document.getElementById('yearlyChart'),
        currentYearDisplay: document.getElementById('currentYearDisplay'),
      },

      // --- INITIALIZATION ---
      init() {
        this.registerServiceWorker();
        this.bindEvents();
        this.setupScrollBehavior();
        
        // Initialize all data fetching at startup
        this.initializeAllData();

        // Load cached auth state for offline support
        const cachedAuthState = localStorage.getItem('authState');
        if (cachedAuthState) {
          const authState = JSON.parse(cachedAuthState);
          this.state.userProfile = authState.userProfile;
          this.state.isAdmin = authState.isAdmin;
          this.state.currentUser = { id: authState.userProfile?.id }; // Temporary user object
          // Update UI based on cached state
          this.updateUI();
        } else {
          // No cached state - show login button by default
          document.getElementById('loginTopBtn').classList.remove('hide');
        }

        // Load cached total fund immediately for offline support
        const cachedTotal = localStorage.getItem('totalFund');
        if (cachedTotal) {
          this.state.totalFund = parseFloat(cachedTotal);
          this.elements.totalFundDisplay.textContent = `‡ß≥ ${parseFloat(cachedTotal).toLocaleString()}`;
        }

        // Load cached fund data
        const cachedAllData = localStorage.getItem('allFundData');
        if (cachedAllData) {
          this.state.allFundData = JSON.parse(cachedAllData);
        }

        const cachedMonthly = localStorage.getItem('cachedMonthlyData');
        if (cachedMonthly) {
          this.state.cachedMonthlyData = JSON.parse(cachedMonthly);
        }

        // Load cached notes
        this.loadNotesFromLocalStorage();

        // --- Setup Deep Link Listener for Mobile App ---
        if (typeof window.Capacitor !== 'undefined' && window.Capacitor.isNativePlatform?.()) {
          const { App, Browser } = window.Capacitor.Plugins;

          App.addListener('appUrlOpen', async (data) => {
            console.log('App opened with URL:', data.url);

            // Close the browser if it's still open
            try {
              await Browser.close();
            } catch (e) {
              // Browser might already be closed
            }

            // Extract hash from URL (format: com.eor.app://oauth#access_token=...)
            const url = data.url;
            const hashIndex = url.indexOf('#');

            if (hashIndex !== -1) {
              const hash = url.substring(hashIndex);

              // Handle OAuth callback
              if (hash.includes('access_token')) {
                try {
                  // Parse the hash manually
                  const params = new URLSearchParams(hash.substring(1));
                  const accessToken = params.get('access_token');
                  const refreshToken = params.get('refresh_token');

                  if (accessToken) {
                    // Set the session manually
                    const { data: sessionData, error } = await db.auth.setSession({
                      access_token: accessToken,
                      refresh_token: refreshToken
                    });

                    if (error) throw error;

                    await this.handleAuthStateChange();
                    this.hideAllModals();
                    this.showNotification('Login successful!');
                  }
                } catch (err) {
                  console.error('OAuth error:', err);
                  this.showNotification('Login failed: ' + err.message, true);
                }
              }
              // Handle password reset
              else if (hash.includes('type=recovery')) {
                try {
                  const params = new URLSearchParams(hash.substring(1));
                  const accessToken = params.get('access_token');
                  const refreshToken = params.get('refresh_token');

                  if (accessToken) {
                    await db.auth.setSession({
                      access_token: accessToken,
                      refresh_token: refreshToken
                    });

                    this.showNotification('Please set your new password');
                    this.showModal('settingsModal');
                  }
                } catch (err) {
                  console.error('Password reset error:', err);
                  this.showNotification('Password reset link invalid', true);
                }
              }
            }
          });
        }

        // --- Finish OAuth redirect when user returns from Google (Web) ---
        // This will parse URL fragments returned by Supabase after OAuth and store the session.
        // We ignore errors because if there's no oauth data in URL, that's fine.
        (async () => {
          try {
            await db.auth.getSessionFromUrl({ storeSession: true });
          } catch (err) {
            // ignore: no session in URL or parsing failed
          }
          await this.handleAuthStateChange(); // Initial check after attempting to finish OAuth
        })();

        this.setupLanguageToggle();
        this.setupMobileBackHandler();

        // Show blood section by default (will be overridden for admins in handleAuthStateChange)
        this.showSection('blood');
      },

      // --- AUTHENTICATION ---
      async initializeAllData() {
        // Mark that we should fetch fresh data (only during initialization)
        this.shouldFetchFreshData = true;
        
        // Fetch all data in parallel
        const promises = [
          this.fetchAllFundData(),
          this.fetchAllDonors(),
          this.fetchAllNotices()
        ];
        
        try {
          await Promise.all(promises);
          console.log('All data fetched successfully');
          
          // Now do all calculations and cache them
          await this.processAndCacheAllCalculations();
          
        } catch (err) {
          console.error('Error initializing data:', err);
          // Continue with cached data
        }
        
        // After initial fetch, disable automatic fetching
        this.shouldFetchFreshData = false;
      },

      async processAndCacheAllCalculations() {
        console.log('Processing all calculations...');
        
        try {
          // 1. Process yearly overview data for all years
          const allData = this.state.allFundData;
          if (allData.length > 0) {
            const years = [...new Set(allData.map(d => parseInt(d.month.split('-')[0])))];
            const yearlyOverviewCache = {};
            
            years.forEach(year => {
              const yearData = allData.filter(d => parseInt(d.month.split('-')[0]) === year);
              const monthlyIncome = new Array(12).fill(0);
              const monthlyExpense = new Array(12).fill(0);
              
yearData.forEach(entry => {
  const monthIndex = parseInt(entry.month.split('-')[1]) - 1;
  if (entry.type === 'income') {
    monthlyIncome[monthIndex] += entry.amount;
  } else if (entry.type === 'expense' && !entry.is_calculation) {
    monthlyExpense[monthIndex] += entry.amount;
  }
});
              
              // Calculate cumulative balance for each month
const previousYearsData = allData.filter(d => parseInt(d.month.split('-')[0]) < year);
let cumulativeBalance = previousYearsData.reduce((acc, entry) => {
  if (entry.type === 'income') return acc + entry.amount;
  // Only subtract expenses where is_calculation is true (NULL/false in DB)
  if (entry.type === 'expense' && !entry.is_calculation) return acc - entry.amount;
  return acc;
}, 0);
              
              const monthlyBalance = monthlyIncome.map((income, i) => {
                cumulativeBalance += income - monthlyExpense[i];
                return cumulativeBalance;
              });
              
              yearlyOverviewCache[year] = {
                monthlyIncome,
                monthlyExpense,
                monthlyBalance
              };
            });
            
            localStorage.setItem('yearlyOverviewCache', JSON.stringify(yearlyOverviewCache));
            console.log('Yearly overview cached for years:', years);
          }
          
// 2. Process and cache all sadakah history (only isDisplay=true)
const allExpenses = allData.filter(d => d.type === 'expense' && !d.is_display)
  .sort((a, b) => {
    if (b.month !== a.month) return b.month.localeCompare(a.month);
    return new Date(b.timestamp) - new Date(a.timestamp);
  });
localStorage.setItem('allSadakahCache', JSON.stringify(allExpenses));
console.log('All sadakah history cached:', allExpenses.length, 'entries');
          
          // 3. Process complete history for modal
          const completeHistoryData = this.calculateCompleteHistory(allData);
          localStorage.setItem('completeHistoryCache', JSON.stringify(completeHistoryData));
          console.log('Complete history cached');
          
// 4. Cache total fund calculation (only isCalculation=true expenses)
const totalFund = allData.reduce((acc, entry) => {
  if (entry.type === 'income') return acc + entry.amount;
  // Only subtract expenses where is_calculation is true (NULL/false in DB)
  if (entry.type === 'expense' && !entry.is_calculation) return acc - entry.amount;
  return acc;
}, 0);
localStorage.setItem('totalFundCache', totalFund.toString());
console.log('Total fund cached:', totalFund);
          
          // 5. Cache collection tab totals
          const allIncome = allData.filter(d => d.type === 'income');
          const totalIncome = allIncome.reduce((sum, item) => sum + item.amount, 0);
          const now = new Date();
          const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
          const monthIncome = allIncome.filter(d => d.month === currentMonthKey).reduce((sum, item) => sum + item.amount, 0);
          
          localStorage.setItem('collectionTabCache', JSON.stringify({
            total: totalIncome,
            currentMonth: monthIncome
          }));
          console.log('Collection tab totals cached');
          
          console.log('All calculations processed and cached successfully!');
          
        } catch (err) {
          console.error('Error processing calculations:', err);
        }
      },

calculateCompleteHistory(data) {
  const monthlyData = {};
  data.forEach(entry => {
    if (!monthlyData[entry.month]) {
      monthlyData[entry.month] = { income: 0, expenses: [] };
    }
    if (entry.type === 'income') {
      monthlyData[entry.month].income += entry.amount;
    } else if (entry.type === 'expense' && !entry.is_calculation) {
      // Only include expenses where is_calculation is true (NULL/false in DB)
      monthlyData[entry.month].expenses.push(entry);
    }
  });
  return monthlyData;
},

      async fetchAllFundData() {
        try {
          const { data, error } = await db.from('fund').select('*').order('month', { ascending: true }).order('timestamp', { ascending: true });
          if (!error && data) {
            localStorage.setItem('allFundData', JSON.stringify(data));
            this.state.allFundData = data;
            
            // Cache monthly aggregated data
            const monthlyCache = {};
            data.forEach(entry => {
              if (!monthlyCache[entry.month]) {
                monthlyCache[entry.month] = [];
              }
              monthlyCache[entry.month].push(entry);
            });
            localStorage.setItem('cachedMonthlyData', JSON.stringify(monthlyCache));
            this.state.cachedMonthlyData = monthlyCache;
          }
        } catch (err) {
          console.error('Error fetching fund data:', err);
        }
      },

      async fetchAllDonors() {
        await window.BloodModule.fetchAllDonors();
      },

async fetchAllNotices() {
    await window.NoticesModule.fetchAllNotices();
  },

      async handleAuthStateChange() {
        await window.AuthModule.handleAuthStateChange();
      },

      async signup(name, emailOrPhone, password) {
        await window.AuthModule.signup(name, emailOrPhone, password);
      },

      async login(emailOrPhone, password) {
        await window.AuthModule.login(emailOrPhone, password);
      },

      async signInWithGoogle() {
        await window.AuthModule.signInWithGoogle();
      },

      async logout() {
        await window.AuthModule.logout();
      },

      // --- DATA FETCHING & RENDERING ---
      loadDataForActiveSection() {
        switch (this.state.activeSection) {
          case 'fund':
            this.loadFundData();
            break;
          case 'blood': this.loadDonors(); break;
          case 'notices': this.loadNotices(); break;
          case 'notes': this.loadNotes(); break;
          case 'notifications': this.loadNotifications(); break;
          case 'userMessages': 
            window.MessagesModule.loadUserMessages();
            window.MessagesModule.updateUserMessageBadge();
            break;
          case 'adminMessages': 
            window.MessagesModule.loadAdminMessages('unread');
            break;
        }
      },

      async updateCollectionTabTotal() {
        await window.FundModule.updateCollectionTabTotal();
      },

      updateCollectionTabTotalOffline() {
        window.FundModule.updateCollectionTabTotalOffline();
      },

      async calculateTotalFund() {
        await window.FundModule.calculateTotalFund();
      },

      async loadAllSadakah() {
        await window.FundModule.loadAllSadakah();
      },

      renderAllSadakahList(sadakahList) {
        window.FundModule.renderAllSadakahList(sadakahList);
      },

      async loadFundData() {
        await window.FundModule.loadFundData();
      },

      renderFundData(data) {
        window.FundModule.renderFundData(data);
      },

      renderFundList(items, element, color) {
        window.FundModule.renderFundList(items, element, color);
      },

      updateFundTotals(income, expense) {
        window.FundModule.updateFundTotals(income, expense);
      },

      async calculateNetWorth() {
        await window.FundModule.calculateNetWorth();
      },

      async loadYearlyChartData() {
        await window.FundModule.loadYearlyChartData();
      },

      renderYearlyChart(income, expense, balance) {
        window.FundModule.renderYearlyChart(income, expense, balance);
      },

      changeYear(delta) {
        window.FundModule.changeYear(delta);
      },

      async updateFundEntry(id, details) {
        await window.FundModule.updateFundEntry(id, details);
      },

      async editFundEntry(id, type) {
        await window.FundModule.editFundEntry(id, type);
      },

      async addFundEntry(type, details) {
        await window.FundModule.addFundEntry(type, details);
      },

      async deleteFundEntry(id) {
        await window.FundModule.deleteFundEntry(id);
      },

      changeMonth(delta) {
        window.FundModule.changeMonth(delta);
      },

      updateFundTabView() {
        window.FundModule.updateFundTabView();
      },

      async copyIncomeList() {
        await window.FundModule.copyIncomeList();
      },

      calculateCompleteHistory(data) {
        return window.FundModule.calculateCompleteHistory(data);
      },

      async showCompleteHistory() {
        await window.FundModule.showCompleteHistory();
      },

      async copyCompleteHistory() {
        await window.FundModule.copyCompleteHistory();
      },

      async loadDonors() {
        await window.BloodModule.loadDonors();
      },

      async loadUsers() {
        const usersList = document.getElementById('usersList');
        usersList.innerHTML = '<div class="loader"></div>';

        // Setup search functionality
        const userSearch = document.getElementById('userSearch');
        const userClearBtn = document.getElementById('userClearBtn');

        userSearch.value = '';
        userClearBtn.classList.add('hide');

        userSearch.addEventListener('input', () => {
          const searchTerm = userSearch.value.trim().toLowerCase();
          userClearBtn.classList.toggle('hide', !searchTerm);
          this.filterUsers(searchTerm);
        });

        userClearBtn.addEventListener('click', () => {
          userSearch.value = '';
          userClearBtn.classList.add('hide');
          this.filterUsers('');
        });

        try {
          // Fetch users from users table
          const { data: usersData, error: usersError } = await db.from('users').select('*').order('name');
          if (usersError) {
            console.error('Error fetching users:', usersError);
            throw usersError;
          }

          // Try to fetch auth users for emails (this requires service role key, might fail)
          let emailMap = {};
          try {
            const { data: authData } = await db.auth.admin.listUsers();
            if (authData && authData.users) {
              authData.users.forEach(authUser => {
                emailMap[authUser.id] = authUser.email || authUser.phone || 'N/A';
              });
            }
          } catch (authError) {
            console.warn('Could not fetch auth users (requires service role):', authError);
            // If we can't get emails, that's okay - we'll show "N/A"
          }

          if (!usersData || usersData.length === 0) {
            usersList.innerHTML = '<div class="text-gray-400 text-center py-4">No users found</div>';
            return;
          }

          // Store users data for filtering
          this.allUsersData = usersData;
          this.allUsersEmailMap = emailMap;

          // Render the users list
          this.renderUsersList(usersData, emailMap);

        } catch (err) {
          console.error('Error loading users:', err);
          usersList.innerHTML = '<div class="text-red-500 text-center py-4">Failed to load users. Make sure you have admin privileges.</div>';
        }
      },

      renderUsersList(usersData, emailMap) {
        const usersList = document.getElementById('usersList');

        if (!usersData || usersData.length === 0) {
          usersList.innerHTML = '<div class="text-gray-400 text-center py-4">No users found</div>';
          return;
        }

        usersList.innerHTML = usersData.map(user => {
          const isCurrentUser = user.id === this.state.currentUser?.id;
          const email = user.email || emailMap[user.id] || 'Email not available';
          const roleColor = {
            admin: 'bg-red-100 text-red-700',
            moderator: 'bg-purple-100 text-purple-700',
            student: 'bg-blue-100 text-blue-700',
            user: 'bg-gray-100 text-gray-700'
          }[user.role] || 'bg-gray-100 text-gray-700';

          return `
            <div class="bg-white border border-gray-200 rounded-lg p-3">
              <div class="flex items-start justify-between mb-2">
                <div class="flex-1">
                  <div class="font-semibold text-gray-800">${user.name}${isCurrentUser ? ' <span class="text-xs text-blue-600">(You)</span>' : ''}</div>
                  <div class="text-xs text-gray-500">${email}</div>
                  <div class="text-xs text-gray-400 mt-1">ID: ${user.id.substring(0, 12)}...</div>
                </div>
                <span class="text-xs px-2 py-1 rounded font-semibold ${roleColor}">${user.role.toUpperCase()}</span>
              </div>
              ${!isCurrentUser ? `
                <div class="flex items-center gap-2 mt-2 pt-2 border-t border-gray-200">
                  <select class="user-role-select flex-1 border border-gray-300 rounded px-2 py-1 text-sm" data-user-id="${user.id}" data-user-name="${user.name}" data-current-role="${user.role}">
                    <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                    <option value="student" ${user.role === 'student' ? 'selected' : ''}>Student</option>
                    <option value="moderator" ${user.role === 'moderator' ? 'selected' : ''}>Moderator</option>
                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                  </select>
                  <button class="save-role-btn bg-green-600 text-white px-4 py-1 rounded text-sm hover:bg-green-700 transition" data-user-id="${user.id}">
                    Change
                  </button>
                </div>
              ` : '<div class="text-xs text-gray-500 mt-2 pt-2 border-t border-gray-200">You cannot change your own role</div>'}
            </div>
          `;
        }).join('');

        // Bind save role buttons with confirmation modals
        document.querySelectorAll('.save-role-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const userId = btn.dataset.userId;
            const roleSelect = document.querySelector(`.user-role-select[data-user-id="${userId}"]`);
            const newRole = roleSelect.value;
            const currentRole = roleSelect.dataset.currentRole;
            const userName = roleSelect.dataset.userName;

            // Check if role actually changed
            if (newRole === currentRole) {
              return this.showNotification('Role is already ' + newRole, true);
            }

            // Store data for confirmation flow
            this.pendingRoleChange = { userId, newRole, currentRole, userName };

            // Show first confirmation
            this.showRoleConfirmation();
          });
        });
      },

      filterUsers(searchTerm) {
        if (!this.allUsersData) return;

        if (!searchTerm) {
          this.renderUsersList(this.allUsersData, this.allUsersEmailMap);
          return;
        }

        const filtered = this.allUsersData.filter(user => {
          const name = (user.name || '').toLowerCase();
          const email = (this.allUsersEmailMap[user.id] || '').toLowerCase();
          const role = (user.role || '').toLowerCase();
          const id = (user.id || '').toLowerCase();

          return name.includes(searchTerm) ||
            email.includes(searchTerm) ||
            role.includes(searchTerm) ||
            id.includes(searchTerm);
        });

        this.renderUsersList(filtered, this.allUsersEmailMap);
      },

      showRoleConfirmation() {
        this.showModal('roleConfirmModal');

        const yesBtn = document.getElementById('roleConfirmYes');
        const noBtn = document.getElementById('roleConfirmNo');

        // Remove old listeners
        const newYesBtn = yesBtn.cloneNode(true);
        const newNoBtn = noBtn.cloneNode(true);
        yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
        noBtn.parentNode.replaceChild(newNoBtn, noBtn);

        newYesBtn.addEventListener('click', () => {
          this.hideAllModals();
          this.showRoleConsequences();
        });

        newNoBtn.addEventListener('click', () => {
          this.hideAllModals();
          this.pendingRoleChange = null;
        });
      },

      showRoleConsequences() {
        const { newRole, currentRole, userName } = this.pendingRoleChange;
        const consequencesText = document.getElementById('roleConsequencesText');

        let consequences = '';

        if (newRole === 'admin') {
          consequences = `
            <p class="font-semibold text-red-600">If you set the role of ${userName} to Admin:</p>
            <ul class="list-disc ml-5 mt-2 space-y-1">
              <li>They can add, delete, and edit collection and sadakah entries</li>
              <li>They will have full control over all blood donor profiles</li>
              <li>They can change the role of any individual, including removing you from admin</li>
              <li>They will have access to the admin menu and all its features</li>
            </ul>
          `;
        } else if (currentRole === 'admin') {
          consequences = `
            <p class="font-semibold text-orange-600">If you remove ${userName} from Admin role:</p>
            <ul class="list-disc ml-5 mt-2 space-y-1">
              <li>They will no longer be able to add, delete, or edit fund entries</li>
              <li>They will lose control over blood donor profiles</li>
              <li>They cannot change user roles anymore</li>
              <li>They will lose access to the admin menu</li>
            </ul>
          `;
        } else if (newRole === 'moderator') {
          consequences = `
            <p class="font-semibold text-purple-600">If you set the role of ${userName} to Moderator:</p>
            <ul class="list-disc ml-5 mt-2 space-y-1">
              <li>Moderator permissions will be defined later</li>
              <li>They will have more privileges than regular users</li>
            </ul>
          `;
        } else if (newRole === 'student') {
          consequences = `
            <p class="font-semibold text-blue-600">If you set the role of ${userName} to Student:</p>
            <ul class="list-disc ml-5 mt-2 space-y-1">
              <li>Student permissions will be defined later</li>
              <li>They may have limited access to certain features</li>
            </ul>
          `;
        } else {
          consequences = `
            <p class="font-semibold text-gray-600">If you set the role of ${userName} to User:</p>
            <ul class="list-disc ml-5 mt-2 space-y-1">
              <li>They will have standard user permissions</li>
              <li>They can manage their own donor profile</li>
              <li>They can post activities</li>
            </ul>
          `;
        }

        consequencesText.innerHTML = consequences;
        this.showModal('roleConsequencesModal');

        const confirmBtn = document.getElementById('roleConsequencesConfirm');
        const cancelBtn = document.getElementById('roleConsequencesCancel');

        // Remove old listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

        newConfirmBtn.addEventListener('click', async () => {
          await this.executeRoleChange();
        });

        newCancelBtn.addEventListener('click', () => {
          this.hideAllModals();
          this.pendingRoleChange = null;
        });
      },

      async executeRoleChange() {
        const { userId, newRole } = this.pendingRoleChange;

        const { error } = await db.from('users').update({ role: newRole }).eq('id', userId);

        if (error) {
          this.showNotification('Failed to update role: ' + error.message, true);
        } else {
          this.showNotification('User role updated successfully!');
          this.loadUsers(); // Reload the list
        }

        this.hideAllModals();
        this.pendingRoleChange = null;
      },


      // --- UI & RENDERING ---
      updateUI() {
        // Auth controls are now inside Settings only
        document.getElementById('settingsBtn').classList.remove('hide');
        document.getElementById('loginTopBtn').classList.toggle('hide', this.state.currentUser);
        
        
        
        // Show User Menu button for regular users
        const isRegularUser = this.state.currentUser && this.state.userProfile?.role === 'user';
        document.getElementById('userMenuBtn').classList.toggle('hide', !isRegularUser);
        
        this.elements.adminMenuBtn.classList.toggle('hide', !this.state.isAdmin);

        // Show Talib button for students
        const isStudent = this.state.userProfile?.role === 'student';
        document.getElementById('talibMenuBtn').classList.toggle('hide', !isStudent);
        document.getElementById('loginBtn').classList.toggle('hide', this.state.currentUser);
        document.getElementById('logoutBtn').classList.toggle('hide', !this.state.currentUser);

        // Show/hide fund tabs based on admin status
        this.elements.fundTabs.classList.toggle('hide', this.state.isAdmin);

        // Admin controls
        this.elements.adminControls.classList.toggle('hide', !this.state.isAdmin);

        // Hide donation info for admins
        const donationInfoText = document.getElementById('donationInfoText');
        if (donationInfoText && donationInfoText.parentElement) {
          donationInfoText.parentElement.classList.toggle('hide', this.state.isAdmin);
        }

        // User-specific buttons
        if (this.state.isAdmin) {
          this.elements.myDonorBtn.classList.remove('hide');
          const isBn = localStorage.getItem('lang') === 'bn';
          this.elements.myDonorBtn.textContent = isBn ? '+ ‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®' : '+ Add Donor Profile';
          this.elements.myDonorBtn.onclick = async () => {
            await this.populateDonorForm();
            this.showModal('donorProfileModal');
          };
        } else {
          this.elements.myDonorBtn.classList.toggle('hide', !this.state.currentUser);
          this.updateMyProfileButtonText();
          this.elements.myDonorBtn.onclick = async () => {
            await this.populateDonorForm();
            this.showModal('donorProfileModal');
          };
        }

        this.elements.postNoticeBtn.classList.toggle('hide', !this.state.currentUser);

        // Show create notification button for admins and moderators
        const createNotifBtn = document.getElementById('createNotificationBtn');
        if (createNotifBtn) {
          createNotifBtn.classList.toggle('hide', !this.canManageNotifications());
        }

        // Always show backup to cloud button for users with notes access
        const backupBtn = document.getElementById('createBackupBtn');
        if (backupBtn) {
          backupBtn.classList.toggle('hide', !this.canAccessNotes());
        }
      },

      updateMonthDisplay() {
        this.elements.currentMonthDisplay.textContent = this.state.currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' });
        this.elements.currentYearDisplay.textContent = this.state.currentYear;
      },

      renderFundList(items, element, color) {
        if (items.length === 0) {
          const isBn = localStorage.getItem('lang') === 'bn';
          const noEntriesText = color === 'green'
            ? (isBn ? '‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡ßá‡¶á' : 'No collection entries')
            : (isBn ? '‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡ßá‡¶á' : 'No sadakah entries');
          element.innerHTML = `<div class="text-gray-400 text-center py-4">${noEntriesText}</div>`;
          return;
        }
element.innerHTML = items.map((item, index) => {
  const textColor = item.highlighted ? 'text-red-600' : 'text-gray-800';
  
  // Determine background color for expenses based on display/calculation flags
  let bgClass = `bg-${color}-50`;
  let opacity = '';
  
  if (color === 'red' && item.type === 'expense') {
    const isDisplay = !item.is_display; // NULL/false in DB = true (displayed)
    const isCalculation = !item.is_calculation; // NULL/false in DB = true (calculated)
    
    if (isDisplay && isCalculation) {
      // Both: normal (as it is)
      bgClass = 'bg-red-50';
    } else if (isDisplay && !isCalculation) {
      // Only display: more transparent
      bgClass = 'bg-red-50';
      opacity = 'opacity-50';
    } else if (!isDisplay && isCalculation) {
      // Only calculation: darker
      bgClass = 'bg-red-200';
    } else {
      // Neither: gray
      bgClass = 'bg-gray-200';
    }
  }
  
  // Convert to Bangladesh time (UTC+6)
  const bdTime = new Date(new Date(item.timestamp).getTime() + (6 * 60 * 60 * 1000));
  const formattedTime = bdTime.toLocaleString('en-GB', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  });
  return `
      <div class="${bgClass} ${opacity} p-1.5 rounded-lg text-sm relative group" title="${formattedTime}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <span class="font-semibold text-gray-600">${index + 1}.</span>
                            <span class="ml-2 ${textColor}">${item.name || item.description}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="font-bold text-${color}-700">‡ß≥ ${item.amount}</div>
                            ${this.state.isAdmin ? `
                                <button data-edit-fund="${item.id}" data-fund-type="${item.type}" class="ml-1 text-blue-500 hover:text-blue-700" style="width: 20px; height: 20px;"><img src="svgs/icon-edit.svg" style="width: 16px; height: 16px;"></button>
                                <button data-delete-fund="${item.id}" class="text-red-500 hover:text-red-700" style="width: 20px; height: 20px;"><img src="svgs/icon-delete.svg" style="width: 16px; height: 16px;"></button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="absolute left-0 top-full mt-1 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">${formattedTime}</div>
                </div>
            `;
        }).join('');
      },

async loadNotices() {
    await window.NoticesModule.loadNotices();
  },

filterAndRenderDonors() {
        window.BloodModule.filterAndRenderDonors();
      },

renderNotices(notices) {
    window.NoticesModule.renderNotices(notices);
  },
      
      renderLoader(section) {
        const sectionMap = {
          fund: [this.elements.incomeList, this.elements.expenseList],
          blood: [this.elements.donorsList],
          notices: [this.elements.noticesList]
        };
        sectionMap[section].forEach(el => el.innerHTML = '<div class="loader"></div>');
      },

      // --- EVENT BINDING & HANDLERS ---
      convertBengaliToEnglishNumber(input) {
        const bengaliDigits = ['‡ß¶', '‡ßß', '‡ß®', '‡ß©', '‡ß™', '‡ß´', '‡ß¨', '‡ß≠', '‡ßÆ', '‡ßØ'];
        const englishDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
        let result = input;
        bengaliDigits.forEach((bn, i) => {
          result = result.replace(new RegExp(bn, 'g'), englishDigits[i]);
        });
        return result;
      },

bindEvents() {
  // Advanced options toggle
  document.getElementById('advancedOptionsToggle')?.addEventListener('click', () => {
    const options = document.getElementById('advancedOptions');
    const arrow = document.getElementById('advancedArrow');
    options.classList.toggle('hide');
    arrow.textContent = options.classList.contains('hide') ? '‚ñº' : '‚ñ≤';
  });

  // Navigation
  document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.addEventListener('click', () => this.showSection(btn.dataset.section));
        });

        // Fund tab switching (non-admin only)
        document.getElementById('collectionTabBtn')?.addEventListener('click', () => {
          this.state.activeFundTab = 'collection';
          this.updateFundTabView();
        });

        document.getElementById('sadakahTabBtn')?.addEventListener('click', () => {
          this.state.activeFundTab = 'sadakah';
          this.updateFundTabView();
        });

        // Admin menu button
        this.elements.adminMenuBtn?.addEventListener('click', () => {
          this.showModal('adminMenuModal');
        });

        // User menu button
        document.getElementById('userMenuBtn')?.addEventListener('click', () => {
          this.showModal('userMenuModal');
        });

        // Talib menu button
        document.getElementById('talibMenuBtn')?.addEventListener('click', () => {
          this.showModal('talibMenuModal');
        });

        // Admin users button
        document.getElementById('adminUsersBtn')?.addEventListener('click', () => {
          this.hideAllModals();
          this.loadUsers();
          this.showModal('adminUsersModal');
        });

        // Admin notes button
        document.getElementById('adminNotesBtn')?.addEventListener('click', () => {
          this.hideAllModals();
          this.showSection('notes');
        });

        // User notes button
        document.getElementById('userNotesBtn')?.addEventListener('click', () => {
          this.hideAllModals();
          this.showSection('notes');
        });

        // User notifications button
        document.getElementById('userNotificationsBtn')?.addEventListener('click', () => {
          this.hideAllModals();
          this.showSection('notifications');
        });

        // Talib notes button
        document.getElementById('talibNotesBtn')?.addEventListener('click', () => {
          this.hideAllModals();
          this.showSection('notes');
        });

        // Talib notifications button
        document.getElementById('talibNotificationsBtn')?.addEventListener('click', () => {
          this.hideAllModals();
          this.showSection('notifications');
        });

        // Talib message admin button
        document.getElementById('talibMessageAdminBtn')?.addEventListener('click', () => {
          this.hideAllModals();
          this.showSection('userMessages');
        });

        // Admin notifications button
        document.getElementById('adminNotificationsBtn')?.addEventListener('click', () => {
          this.hideAllModals();
          this.showSection('notifications');
        });

        // Message admin button
        document.getElementById('messageAdminBtn')?.addEventListener('click', () => {
          this.hideAllModals();
          this.showSection('userMessages');
        });

        // Admin messages button
        document.getElementById('adminMessagesBtn')?.addEventListener('click', () => {
          this.hideAllModals();
          this.showSection('adminMessages');
        });

        // Compose new message button
        document.getElementById('composeNewMessageBtn')?.addEventListener('click', () => {
          window.MessagesModule.openComposeMessage();
        });

        // Admin message tabs
        document.querySelectorAll('.admin-message-tab').forEach(btn => {
          btn.addEventListener('click', () => {
            window.MessagesModule.loadAdminMessages(btn.dataset.tab);
          });
        });

        // Compose message form
        document.getElementById('composeMessageForm')?.addEventListener('submit', async (e) => {
          e.preventDefault();
          const subjectSelect = document.getElementById('messageSubject');
          const customSubject = document.getElementById('customSubject');
          const subject = subjectSelect.value === 'Other' ? customSubject.value.trim() : subjectSelect.value;
          const message = document.getElementById('messageContent').value.trim();

          if (!subject) {
            this.showNotification('Please enter a subject', true);
            return;
          }

          await window.MessagesModule.sendMessageToAdmin(subject, message);
        });

        // Custom subject toggle
        document.getElementById('messageSubject')?.addEventListener('change', (e) => {
          const customSection = document.getElementById('customSubjectSection');
          if (e.target.value === 'Other') {
            customSection.classList.remove('hide');
          } else {
            customSection.classList.add('hide');
          }
        });

        // Update message status when admin closes message modal
        const adminMsgModal = document.getElementById('adminViewMessageModal');
        if (adminMsgModal) {
          const closeBtn = adminMsgModal.querySelector('[data-close-modal]');
          if (closeBtn) {
            closeBtn.addEventListener('click', () => {
              window.MessagesModule.updateMessageStatusOnClose();
            });
          }
        }

        // Mark user reply as read when viewing
        document.addEventListener('click', (e) => {
          const viewMsgBtn = e.target.closest('[data-view-message]');
          if (viewMsgBtn) {
            const messageId = viewMsgBtn.dataset.viewMessage;
            // Check if message has admin reply
            setTimeout(() => {
              const replySection = document.getElementById('viewMessageReply');
              if (replySection && replySection.innerHTML.includes('Admin Reply')) {
                window.MessagesModule.markUserReplyAsRead(messageId);
              }
            }, 100);
          }
        });

        // Create notification button
        document.getElementById('createNotificationBtn')?.addEventListener('click', () => {
          document.getElementById('notificationId').value = '';
          document.getElementById('notificationForm').reset();
          document.getElementById('notificationModalTitle').textContent = 'Create Notification';
          this.showModal('notificationModal');
        });

        // Notes buttons
        document.getElementById('createNoteBtn')?.addEventListener('click', () => {
          this.editNote(null);
        });

        document.getElementById('createBackupBtn')?.addEventListener('click', () => {
          if (this.canBackupNotesToCloud()) {
            this.backupNotesToServer();
          } else {
            this.showModal('notesAccessDeniedModal');
          }
        });

        document.getElementById('exportNotesBtn')?.addEventListener('click', () => {
          this.exportNotesToFile();
        });

        document.getElementById('importNotesBtn')?.addEventListener('click', () => {
          document.getElementById('importNotesFile').click();
        });

        document.getElementById('importNotesFile')?.addEventListener('change', (e) => {
          this.importNotesFromFile(e);
        });

        document.getElementById('editNoteBtn')?.addEventListener('click', () => {
          if (this.state.currentNote) {
            this.editNote(this.state.currentNote.id);
          }
        });

        document.getElementById('deleteNoteViewBtn')?.addEventListener('click', () => {
          if (this.state.currentNote) {
            this.deleteNote(this.state.currentNote.id);
          }
        });

        document.getElementById('deleteNoteEditBtn')?.addEventListener('click', () => {
          const noteId = document.getElementById('noteEditId').value;
          if (noteId) {
            this.deleteNote(noteId);
          }
        });

        document.getElementById('saveNoteBtn')?.addEventListener('click', () => {
          this.saveNote();
        });

        document.getElementById('notesFormattingGuideBtn')?.addEventListener('click', () => {
          this.showModal('formattingGuideModal');
        });

        // Unsaved changes warning
        document.querySelector('#noteEditModal [data-close-modal]')?.addEventListener('click', (e) => {
          if (this.checkUnsavedChanges()) {
            e.stopPropagation();
            this.showModal('unsavedChangesModal');
          }
        });

        document.getElementById('discardChangesBtn')?.addEventListener('click', () => {
          this.hideAllModals();
        });

        document.getElementById('keepEditingBtn')?.addEventListener('click', () => {
          document.getElementById('unsavedChangesModal').classList.add('hide');
          this.showModal('noteEditModal');
        });

        // Set initial active tab
        this.updateActiveTab();
        document.getElementById('refreshBtn').addEventListener('click', () => this.refreshApp());
        document.getElementById('settingsBtn').addEventListener('click', () => this.showModal('settingsModal'));
        document.getElementById('loginTopBtn').addEventListener('click', () => this.showModal('loginModal'));
        document.getElementById('loginBtn').addEventListener('click', () => this.showModal('loginModal'));
        document.getElementById('logoutBtn').addEventListener('click', () => this.logout());

        // Google OAuth button in login modal
        const googleBtn = document.getElementById('googleLoginBtn');
        if (googleBtn) {
          googleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            this.signInWithGoogle();
          });
        }


        // Modals
        document.getElementById('showSignupBtn').addEventListener('click', () => this.showModal('signupModal'));
        document.getElementById('showLoginBtn').addEventListener('click', () => this.showModal('loginModal'));
        document.getElementById('forgotPasswordBtn').addEventListener('click', () => this.showModal('forgotPasswordModal'));
        document.getElementById('backToLoginBtn').addEventListener('click', () => this.showModal('loginModal'));

        // Show/Hide Password toggles
        document.getElementById('toggleLoginPassword').addEventListener('click', () => {
          const input = document.getElementById('loginPassword');
          const icon = document.getElementById('loginEyeIcon');
          if (input.type === 'password') {
            input.type = 'text';
            icon.src = 'svgs/icon-eye-slash.svg';
          } else {
            input.type = 'password';
            icon.src = 'svgs/icon-eye.svg';
          }
        });
        document.getElementById('toggleSignupPassword').addEventListener('click', () => {
          const input = document.getElementById('signupPassword');
          const icon = document.getElementById('signupEyeIcon');
          if (input.type === 'password') {
            input.type = 'text';
            icon.src = 'svgs/icon-eye-slash.svg';
          } else {
            input.type = 'password';
            icon.src = 'svgs/icon-eye.svg';
          }
        });
        document.getElementById('toggleSignupConfirmPassword').addEventListener('click', () => {
          const input = document.getElementById('signupConfirmPassword');
          const icon = document.getElementById('signupConfirmEyeIcon');
          if (input.type === 'password') {
            input.type = 'text';
            icon.src = 'svgs/icon-eye-slash.svg';
          } else {
            input.type = 'password';
            icon.src = 'svgs/icon-eye.svg';
          }
        });
        document.querySelectorAll('[data-modal]').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (btn.dataset.modal === 'donorProfileModal' && btn.id !== 'myDonorBtn') await this.populateDonorForm();

            // Reset income modal when opening for new entry
            if (btn.dataset.modal === 'addIncomeModal') {
              const isBn = localStorage.getItem('lang') === 'bn';
              document.getElementById('incomeId').value = '';
              document.querySelector('#addIncomeModal h2').textContent = isBn ? '‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®' : 'Add Collection';
              document.querySelector('#addIncomeForm button[type="submit"]').textContent = isBn ? '‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®' : 'Add';
              document.getElementById('addIncomeForm').reset();
            }

            // Reset expense modal when opening for new entry
            if (btn.dataset.modal === 'addExpenseModal') {
              const isBn = localStorage.getItem('lang') === 'bn';
              document.getElementById('expenseId').value = '';
              document.querySelector('#addExpenseModal h2').textContent = isBn ? '‡¶∏‡¶æ‡¶¶‡¶æ‡¶ï‡¶æ‡¶π ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®' : 'Add Sadakah';
              document.querySelector('#addExpenseForm button[type="submit"]').textContent = isBn ? '‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®' : 'Add';
              document.getElementById('addExpenseForm').reset();
            }

            this.showModal(btn.dataset.modal);
          });
        });
        document.querySelectorAll('[data-close-modal]').forEach(btn => {
          btn.addEventListener('click', () => this.hideAllModals());
        });

        // Forms
        document.getElementById('signupForm').addEventListener('submit', e => {
          e.preventDefault();
          const name = e.target.elements.signupName.value.trim();
          const emailOrPhone = e.target.elements.signupEmail.value.trim();
          const pass = e.target.elements.signupPassword.value;
          const confirmPass = e.target.elements.signupConfirmPassword.value;

          if (!name) {
            this.hideAllModals();
            return this.showNotification('Please enter your full name', true);
          }
          if (pass.length < 6) {
            this.hideAllModals();
            return this.showNotification('Password must be at least 6 characters long', true);
          }
          if (pass !== confirmPass) {
            this.hideAllModals();
            return this.showNotification('Passwords do not match', true);
          }
          this.signup(name, emailOrPhone, pass);
        });
        document.getElementById('loginForm').addEventListener('submit', e => {
          e.preventDefault();
          const emailOrPhone = e.target.elements.loginEmail.value.trim();
          const password = e.target.elements.loginPassword.value;
          if (!emailOrPhone || !password) {
            this.hideAllModals();
            return this.showNotification('Please enter both email/phone and password', true);
          }
          this.login(emailOrPhone, password);
        });
        document.getElementById('forgotPasswordForm').addEventListener('submit', async e => {
          e.preventDefault();
          const email = e.target.elements.forgotEmail.value.trim();
          if (!email) {
            this.hideAllModals();
            return this.showNotification('Please enter your email', true);
          }
          // Detect if running in native app or web
          const isNative = typeof window.Capacitor !== 'undefined';
          const redirectTo = isNative ? 'com.eor.app://reset-password' : window.location.origin;

          const { error } = await db.auth.resetPasswordForEmail(email, {
            redirectTo
          });
          if (error) {
            this.hideAllModals();
            return this.showNotification(error.message, true);
          }
          this.hideAllModals();
          this.showNotification('Password reset link sent to your email!');
          e.target.reset();
        });
        document.getElementById('addIncomeForm').addEventListener('submit', async e => {
          e.preventDefault();
          const incomeId = document.getElementById('incomeId').value;
          const name = e.target.elements.incomeName.value;
          const amountInput = this.convertBengaliToEnglishNumber(e.target.elements.incomeAmount.value);
          const amount = parseFloat(amountInput);
          const highlighted = e.target.elements.incomeHighlighted.checked;

          if (incomeId) {
            // Update existing entry
            await this.updateFundEntry(incomeId, { name, amount, highlighted });
          } else {
            // Add new entry
            await this.addFundEntry('income', { name, amount, highlighted });
          }
          e.target.reset();
          document.getElementById('incomeId').value = '';
        });
document.getElementById('addExpenseForm').addEventListener('submit', async e => {
  e.preventDefault();
  const expenseId = document.getElementById('expenseId').value;
  const description = e.target.elements.expenseDesc.value;
  const amountInput = this.convertBengaliToEnglishNumber(e.target.elements.expenseAmount.value);
  const amount = parseFloat(amountInput);
  const additional_info = e.target.elements.expenseAdditionalInfo.value.trim() || null;
  const highlighted = e.target.elements.expenseHighlighted.checked;
  
  // Inverse logic: checked (true) = store NULL/false, unchecked (false) = store true
  const isDisplay = document.getElementById('expenseDisplay').checked ? null : true;
  const isCalculation = document.getElementById('expenseCalculation').checked ? null : true;

  if (expenseId) {
    await this.updateFundEntry(expenseId, { 
      description, amount, additional_info, highlighted,
      is_display: isDisplay,
      is_calculation: isCalculation
    });
  } else {
    await this.addFundEntry('expense', { 
      description, amount, additional_info, highlighted,
      is_display: isDisplay,
      is_calculation: isCalculation
    });
  }
  e.target.reset();
  document.getElementById('expenseId').value = '';
  // Reset advanced options to default (display and calculation checked)
  document.getElementById('expenseDisplay').checked = true;
  document.getElementById('expenseCalculation').checked = true;
  document.getElementById('advancedOptions').classList.add('hide');
  document.getElementById('advancedArrow').textContent = '‚ñº';
});
        document.getElementById('postNoticeForm').addEventListener('submit', async e => {
          e.preventDefault();
          const text = e.target.elements.noticeText.value.trim();
          const noticeId = document.getElementById('noticeId').value;

          if (!text) return this.showNotification('Please add some text.', true);

          if (noticeId) {
            // Update existing notice
            const { error } = await db.from('notices').update({ text }).eq('id', parseInt(noticeId));
            if (error) return this.showNotification(error.message, true);
            this.showNotification('Activity updated!');
          } else {
            // Create new notice
            const { error } = await db.from('notices').insert({
              text,
              author_name: this.state.userProfile.name,
              author_id: this.state.currentUser.id
            });
            if (error) return this.showNotification(error.message, true);
            this.showNotification('Activity posted!');
          }

          this.hideAllModals();
          this.loadNotices();
          e.target.reset();
          document.getElementById('noticeId').value = '';
        });
        document.getElementById('notificationForm').addEventListener('submit', async e => {
        e.preventDefault();
        const notificationId = document.getElementById('notificationId').value;
        const title = document.getElementById('notificationTitle').value.trim();
        const content = document.getElementById('notificationContent').value.trim();
        const targetAudience = document.getElementById('notificationTarget').value;

        if (!title || !content || !targetAudience) {
          return this.showNotification('Please fill in all fields', true);
        }

        if (notificationId) {
          // Update existing notification
          const { error } = await db.from('notifications').update({
            title,
            content,
            target_audience: targetAudience
          }).eq('id', parseInt(notificationId));

          if (error) return this.showNotification(error.message, true);
          this.showNotification('Notification updated!');
        } else {
          // Create new notification
          const { error } = await db.from('notifications').insert({
            title,
            content,
            target_audience: targetAudience,
            created_by: this.state.currentUser.id
          });

          if (error) return this.showNotification(error.message, true);
          this.showNotification('Notification sent!');
        }

        this.hideAllModals();
        this.loadNotifications();
      });

      document.getElementById('donorProfileForm').addEventListener('submit', async e => {
          e.preventDefault();
          const donorId = document.getElementById('donorId').value;
          
          const hasLastDonated = document.getElementById('donorHasLastDonated').checked;
          const lastDonatedValue = document.getElementById('donorLastDonated').value;

          const profile = {
            name: e.target.elements.donorName.value,
            phone: e.target.elements.donorPhone.value,
            blood_group: e.target.elements.donorBloodGroup.value,
            location: e.target.elements.donorLocation.value,
            available: e.target.elements.donorAvailable.checked,
            last_donated: (hasLastDonated && lastDonatedValue) ? lastDonatedValue : null,
          };

          if (donorId) {
            // Update existing profile (admin or user's own)
            const { error } = await db.from('donors').update(profile).eq('id', parseInt(donorId));
            if (error) return this.showNotification(error.message, true);
          } else {
            // Create new profile
            profile.user_id = this.state.isAdmin ? null : this.state.currentUser.id;
            profile.created_by_admin = this.state.isAdmin;
            const { error } = await db.from('donors').insert(profile);
            if (error) return this.showNotification(error.message, true);
          }

          this.showNotification('Profile saved!');
          this.hideAllModals();
          this.loadDonors();
        });
        this.elements.deleteDonorBtn.addEventListener('click', async () => {
          if (!confirm('Are you sure you want to delete this donor profile?')) return;
          const donorId = document.getElementById('donorId').value;
          if (!donorId) return;
          const { error } = await db.from('donors').delete().eq('id', parseInt(donorId));
          if (error) return this.showNotification(error.message, true);
          this.showNotification('Profile deleted.');
          this.hideAllModals();
          this.loadDonors();
        });

        // Toggle last donated date field visibility
        document.getElementById('donorHasLastDonated').addEventListener('change', (e) => {
          const dateField = document.getElementById('donorLastDonated');
          if (e.target.checked) {
            dateField.classList.remove('hide');
          } else {
            dateField.classList.add('hide');
            dateField.value = '';
          }
        });

        // Other interactions
        document.getElementById('prevMonthBtn').addEventListener('click', () => this.changeMonth(-1));
        document.getElementById('nextMonthBtn').addEventListener('click', () => this.changeMonth(1));
        document.getElementById('prevYearBtn').addEventListener('click', () => this.changeYear(-1));
        document.getElementById('nextYearBtn').addEventListener('click', () => this.changeYear(1));
        this.elements.mainContent.addEventListener('click', e => {
          if (e.target.dataset.deleteFund) this.deleteFundEntry(e.target.dataset.deleteFund);
          if (e.target.dataset.editFund) this.editFundEntry(e.target.dataset.editFund, e.target.dataset.fundType);
          // Handle clicks on img inside buttons
          if (e.target.tagName === 'IMG' && e.target.parentElement.dataset.deleteFund) {
            this.deleteFundEntry(e.target.parentElement.dataset.deleteFund);
          }
          if (e.target.tagName === 'IMG' && e.target.parentElement.dataset.editFund) {
            this.editFundEntry(e.target.parentElement.dataset.editFund, e.target.parentElement.dataset.fundType);
          }
        });
        document.getElementById('bloodFilter').addEventListener('change', () => {
          this.state.allDonors = window.BloodModule.shuffleDonors(this.state.allDonors);
          window.BloodModule.filterAndRenderDonors();
        });

        // Blood search toggle
        document.getElementById('bloodSearchBtn').addEventListener('click', () => {
          const searchInput = document.getElementById('bloodSearch');
          const filterSelect = document.getElementById('bloodFilter');
          const searchBtn = document.getElementById('bloodSearchBtn');
          const clearBtn = document.getElementById('bloodClearBtn');

          searchInput.classList.remove('hide');
          filterSelect.classList.add('hide');
          searchBtn.classList.add('hide');
          clearBtn.classList.remove('hide');
          searchInput.focus();
        });

        // Blood search input
        document.getElementById('bloodSearch').addEventListener('input', () => {
          this.filterAndRenderDonors();
        });

        // Blood search blur
        document.getElementById('bloodSearch').addEventListener('blur', () => {
          const searchInput = document.getElementById('bloodSearch');
          if (!searchInput.value.trim()) {
            setTimeout(() => {
              const filterSelect = document.getElementById('bloodFilter');
              const searchBtn = document.getElementById('bloodSearchBtn');
              const clearBtn = document.getElementById('bloodClearBtn');

              searchInput.classList.add('hide');
              filterSelect.classList.remove('hide');
              searchBtn.classList.remove('hide');
              clearBtn.classList.add('hide');
              this.filterAndRenderDonors();
            }, 200);
          }
        });

        // Blood search clear
        document.getElementById('bloodClearBtn').addEventListener('click', () => {
          const searchInput = document.getElementById('bloodSearch');
          searchInput.value = '';
          searchInput.focus();
          this.filterAndRenderDonors();
        }); document.getElementById('showYearlyChartBtn').addEventListener('click', () => {
          this.showModal('yearlyChartModal');
          this.loadYearlyChartData();
        });
        document.getElementById('totalFundBtn').addEventListener('click', () => this.showCompleteHistory());
        document.getElementById('copyIncomeBtn').addEventListener('click', () => this.copyIncomeList());
        document.getElementById('copyHistoryBtn').addEventListener('click', () => this.copyCompleteHistory());

        // Copy donation numbers on click
        document.addEventListener('click', (e) => {
          const copyBtn = e.target.closest('[data-copy-number]');
          if (copyBtn) {
            const number = copyBtn.dataset.copyNumber;
            navigator.clipboard.writeText(number).then(() => {
              this.showNotification('Number copied: ' + number);
            });
          }
        });
      },

async editNotice(noticeId) {
    await window.NoticesModule.editNotice(noticeId);
  },

async bumpNotice(noticeId) {
    await window.NoticesModule.bumpNotice(noticeId);
  },

async deleteNotice(noticeId) {
    await window.NoticesModule.deleteNotice(noticeId);
  },

      async populateDonorForm(donorId = null) {
        await window.BloodModule.populateDonorForm(donorId);
      },

      // --- NOTES MANAGEMENT ---
canAccessNotes() {
  return window.NotesModule.canAccessNotes();
},

canBackupNotesToCloud() {
  return window.NotesModule.canBackupNotesToCloud();
},

canManageNotifications() {
  return window.NotificationsModule.canManageNotifications();
},

async loadNotifications() {
  await window.NotificationsModule.loadNotifications();
},

renderNotifications(notifications) {
  window.NotificationsModule.renderNotifications(notifications);
},

updateNotificationBadge(notifications) {
  window.NotificationsModule.updateNotificationBadge(notifications);
},

async editNotification(notificationId) {
  await window.NotificationsModule.editNotification(notificationId);
},

async bumpNotification(notificationId) {
  await window.NotificationsModule.bumpNotification(notificationId);
},

async deleteNotification(notificationId) {
  await window.NotificationsModule.deleteNotification(notificationId);
},
loadNotesFromLocalStorage() {
  window.NotesModule.loadNotesFromLocalStorage();
},

saveNotesToLocalStorage() {
  window.NotesModule.saveNotesToLocalStorage();
},

async syncNotesFromServer() {
  await window.NotesModule.syncNotesFromServer();
},

exportNotesToFile() {
  window.NotesModule.exportNotesToFile();
},

async importNotesFromFile(event) {
  await window.NotesModule.importNotesFromFile(event);
},

async backupNotesToServer() {
  await window.NotesModule.backupNotesToServer();
},

updateLastSyncDisplay() {
  window.NotesModule.updateLastSyncDisplay();
},

loadNotes() {
  window.NotesModule.loadNotes();
},

renderNotes() {
  window.NotesModule.renderNotes();
},

stripFormatting(text) {
  return window.NotesModule.stripFormatting(text);
},

parseFormatting(text) {
  return window.NotesModule.parseFormatting(text);
},

viewNote(noteId) {
  window.NotesModule.viewNote(noteId);
},

renderFormattedContent(content) {
  return window.NotesModule.renderFormattedContent(content);
},

editNote(noteId = null) {
  window.NotesModule.editNote(noteId);
},

setupNoteEditorEventListeners() {
  window.NotesModule.setupNoteEditorEventListeners();
},

async saveNote() {
  await window.NotesModule.saveNote();
},

generateNoteId() {
  return window.NotesModule.generateNoteId();
},

async deleteNote(noteId) {
  await window.NotesModule.deleteNote(noteId);
},

checkUnsavedChanges() {
  return window.NotesModule.checkUnsavedChanges();
},

      // --- UTILITIES ---
      showSection(sectionId) {
        this.state.activeSection = sectionId;
        document.querySelectorAll('.section').forEach(s => s.classList.add('hide'));
        const section = document.getElementById(`${sectionId}Section`);
        if (section) {
          section.classList.remove('hide');
          section.classList.add('fade-in');
        }
        this.updateActiveTab();

        // Handle fund section display based on user role
        if (sectionId === 'fund') {
          if (this.state.isAdmin) {
            // Admin: hide tabs, show collection view only
            if (this.elements.fundTabs) {
              this.elements.fundTabs.classList.add('hide');
            }
            if (this.elements.collectionView) {
              this.elements.collectionView.classList.remove('hide');
            }
            if (this.elements.sadakahListView) {
              this.elements.sadakahListView.classList.add('hide');
            }
          } else {
            // Non-admin: show tabs, default to sadakah tab
            this.state.activeFundTab = 'sadakah';
            this.updateFundTabView();
          }
        }

        this.loadDataForActiveSection();
      },

      updateActiveTab() {
        document.querySelectorAll('.nav-btn').forEach(btn => {
          if (btn.dataset.section === this.state.activeSection) {
            btn.classList.add('bg-emerald-100', 'border-2', 'border-emerald-500');
            btn.classList.remove('bg-white');
          } else {
            btn.classList.remove('bg-emerald-100', 'border-2', 'border-emerald-500');
            btn.classList.add('bg-white');
          }
        });
      },

      showModal(modalId) {
        this.hideAllModals();
        const modal = document.getElementById(modalId);
        if (modal) {
          // Calculate scrollbar width
          const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
          document.documentElement.style.setProperty('--scrollbar-width', `${scrollbarWidth}px`);

          modal.classList.remove('hide');
          document.body.classList.add('modal-open');

          // Define modals that should NOT close on outside click (text/data input modals)
          const noOutsideCloseModals = [
            'signupModal', 'loginModal', 'forgotPasswordModal',
            'addIncomeModal', 'addExpenseModal', 'postNoticeModal',
            'donorProfileModal', 'noteEditModal', 'noteViewModal'
          ];

          // Close on outside click only for non-text modals
          if (!noOutsideCloseModals.includes(modalId)) {
            setTimeout(() => {
              modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                  this.hideAllModals();
                }
              });
            }, 0);
          }
        }
      },

hideAllModals() {
        document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hide'));
        document.body.classList.remove('modal-open');
        document.documentElement.style.setProperty('--scrollbar-width', '0px');
        
        // Close any open dropdowns
        document.querySelectorAll('.note-dropdown').forEach(d => d.classList.remove('active'));
        
        // Clean up click-outside listener
        if (this.closeDropdownsHandler) {
          document.removeEventListener('click', this.closeDropdownsHandler);
          this.closeDropdownsHandler = null;
        }
        
        // Reset note editor when closing modals
        this.noteEditor = null;
      },

      showNotification(message, isError = false) {
        const el = this.elements.notification;
        el.textContent = message;
        el.className = isError ? 'error' : 'success';
        el.classList.remove('hide');
        setTimeout(() => el.classList.add('hide'), 3000);
      },

      async refreshApp() {
        this.showNotification('Refreshing app...');

        // Re-enable data fetching for next initialization
        this.shouldFetchFreshData = true;

        // Clear service worker cache
        if ('serviceWorker' in navigator && 'caches' in window) {
          const cacheNames = await caches.keys();
          await Promise.all(cacheNames.map(name => caches.delete(name)));
        }

        // Reload the page
        window.location.reload(true);
      },

      registerServiceWorker() {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/serviceWorker.js')
            .then(registration => {
              console.log('Service Worker registered successfully:', registration.scope);
            })
            .catch(error => {
              console.log('Service Worker registration failed:', error);
            });
        }
      },
      updateMyProfileButtonText() {
        window.BloodModule.updateMyProfileButtonText();
      },

      setupScrollBehavior() {
        const topBar = document.querySelector('.bg-gradient-to-r');
        let lastScrollTop = 0;
        const topBarHeight = topBar.offsetHeight;
        let currentTranslate = 0;

        // Create placeholder for blood filter
        const bloodFilterContainer = document.getElementById('bloodFilterContainer');
        const placeholder = document.createElement('div');
        placeholder.id = 'bloodFilterPlaceholder';
        if (bloodFilterContainer) {
          bloodFilterContainer.parentNode.insertBefore(placeholder, bloodFilterContainer.nextSibling);
        }

        // Store original position of blood filter
        let bloodFilterOriginalTop = 0;

        // Calculate original position on load and section change
        const calculateFilterPosition = () => {
          if (bloodFilterContainer && this.state.activeSection === 'blood') {
            bloodFilterContainer.classList.remove('sticky');
            placeholder.classList.remove('active');
            setTimeout(() => {
              bloodFilterOriginalTop = bloodFilterContainer.getBoundingClientRect().top + window.pageYOffset;
            }, 100);
          }
        };

        // Calculate initial position
        setTimeout(calculateFilterPosition, 500);

        // Recalculate when switching to blood section
        const originalShowSection = this.showSection.bind(this);
        this.showSection = function (sectionId) {
          originalShowSection(sectionId);
          if (sectionId === 'blood') {
            setTimeout(calculateFilterPosition, 300);
          }
        };

        window.addEventListener('scroll', () => {
          const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          const scrollDelta = scrollTop - lastScrollTop;

          // Check if we're in blood section
          const isBloodSection = this.state.activeSection === 'blood';

          if (isBloodSection) {
            // Calculate if filter should be sticky
            const shouldBeSticky = scrollTop >= bloodFilterOriginalTop;

            if (shouldBeSticky) {
              // Filter is sticky
              if (bloodFilterContainer) {
                const filterHeight = bloodFilterContainer.offsetHeight;
                bloodFilterContainer.classList.add('sticky');
                placeholder.classList.add('active');
                placeholder.style.height = `${filterHeight}px`;
              }
            } else {
              // Filter is back to original position
              if (bloodFilterContainer) {
                bloodFilterContainer.classList.remove('sticky');
                placeholder.classList.remove('active');
              }
            }

            // Topbar scrolls naturally - remove any transform
            topBar.style.transform = '';
            topBar.style.position = 'relative';
          } else {
            // Other sections: normal topbar sticky behavior
            topBar.style.position = '';
            currentTranslate -= scrollDelta;
            currentTranslate = Math.max(-topBarHeight, Math.min(0, currentTranslate));
            topBar.style.transform = `translateY(${currentTranslate}px)`;

            // Remove sticky from filter if present
            if (bloodFilterContainer) {
              bloodFilterContainer.classList.remove('sticky');
              placeholder.classList.remove('active');
            }
          }

          lastScrollTop = scrollTop;
        }, { passive: true });
      },

      setupLanguageToggle() {
        const toggle = document.getElementById('bengaliModeToggle');
        const appTitle = document.getElementById('appTitle');
        const elementsToTranslate = {
          // --- Navigation / Tabs ---
          fund: { en: 'Fund History', bn: '‡¶´‡¶æ‡¶®‡ßç‡¶°' },
          notices: { en: 'Activities', bn: '‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ' },
          blood: { en: 'Blood Donors', bn: '‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶®' },

          // --- Buttons ---
          income: { en: 'Collection', bn: '‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®' },
          expense: { en: 'Sadakah', bn: '‡¶∏‡¶æ‡¶¶‡¶æ‡¶ï‡¶æ‡¶π' },
          copyList: { en: '<img src="svgs/icon-copy.svg"> Copy List', bn: '<img src="svgs/icon-copy.svg"> ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®' },
          addIncome: { en: '+ Collection', bn: '+ ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®' },
          addExpense: { en: '+ Sadakah', bn: '+ ‡¶∏‡¶æ‡¶¶‡¶æ‡¶ï‡¶æ‡¶π' },
          viewOverview: { en: '<img src="svgs/overview-icon.svg" style="width: 20px; height: 20px; display: inline;"> View Yearly Overview', bn: '<img src="svgs/overview-icon.svg" style="width: 20px; height: 20px; display: inline;"> ‡¶è‡¶á ‡¶¨‡¶õ‡¶∞‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£' },
          myProfile: { en: 'My Profile', bn: '‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤' },
          postActivity: { en: 'Post Activity', bn: '‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®' },
          save: { en: 'Save', bn: '‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®' },
          cancel: { en: 'Cancel', bn: '‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®' },
          delete: { en: 'Delete', bn: '‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®' },
          close: { en: 'Close', bn: '‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®' },

          // --- Authentication ---
          login: { en: 'Login', bn: '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®' },
          logout: { en: 'Logout', bn: '‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®' },
          signup: { en: 'Sign Up', bn: '‡¶∏‡¶æ‡¶á‡¶®-‡¶Ü‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®' },
          settings: { en: 'Settings', bn: '‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏' },
          email: { en: 'Email', bn: '‡¶á‡¶Æ‡ßá‡¶á‡¶≤' },
          password: { en: 'Password', bn: '‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°' },
          confirmPassword: { en: 'Confirm Password', bn: '‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®' },
          fullName: { en: 'Full Name', bn: '‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶® ‡¶®‡¶æ‡¶Æ' },
          dontHaveAccount: { en: "Don't have an account? Sign up", bn: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? ‡¶∏‡¶æ‡¶á‡¶®-‡¶Ü‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®' },
          alreadyHaveAccount: { en: 'Already have an account? Login', bn: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®' },
          forgotPassword: { en: 'Forgot Password?', bn: '‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®?' },
          forgotPasswordTitle: { en: 'Forgot Password', bn: '‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®' },
          forgotPasswordDesc: { en: "Enter your email address and we'll send you a password reset link.", bn: '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®, ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßã‡•§' },
          sendResetLink: { en: 'Send Reset Link', bn: '‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶®' },
          backToLogin: { en: 'Back to Login', bn: '‡¶≤‡¶ó‡¶á‡¶®‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®' },

          // --- Donor Form ---
          donorTitle: { en: 'My Donor Profile', bn: '‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤' },
          phoneNumber: { en: 'Phone Number', bn: '‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞' },
          bloodGroup: { en: 'Select Blood Group', bn: '‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®' },
          location: { en: 'Location', bn: '‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶®' },
          available: { en: 'Available to donate', bn: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≠‡ßá‡¶á‡¶≤‡ßá‡¶¨‡¶≤' },
          notAvailable: { en: 'Not Available', bn: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≠‡ßá‡¶á‡¶≤‡ßá‡¶¨‡¶≤ ‡¶®‡ßü' },
          allGroups: { en: 'All Blood Groups', bn: '‡¶∏‡¶ï‡¶≤ ‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™' },

          // --- Modals ---
          loginModal: { en: 'Login', bn: '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®' },
          signupModal: { en: 'Sign Up', bn: '‡¶∏‡¶æ‡¶á‡¶®-‡¶Ü‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®' },
          addIncomeModal: { en: 'Add Collection', bn: '‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®' },
          addExpenseModal: { en: 'Add Sadakah', bn: '‡¶∏‡¶æ‡¶¶‡¶æ‡¶ï‡¶æ‡¶π ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®' },
          donorProfileModal: { en: 'My Donor Profile', bn: '‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤' },
          postNoticeModal: { en: 'Post Activity', bn: '‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®' },
          yearlyChartModal: { en: 'Yearly Overview', bn: '‡¶¨‡¶æ‡ßé‡¶∏‡¶∞‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø' },
          completeHistoryModal: { en: 'Complete Fund History', bn: '‡¶´‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÅ‡¶∞‡ßç‡¶£ ‡¶§‡¶•‡ßç‡¶Ø' },
          optionalImage: { en: 'Optional Image:', bn: '‡¶õ‡¶¨‡¶ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤)' },

          // --- Chart Labels ---
          incomeChart: { en: 'Collection', bn: '‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®' },
          expenseChart: { en: 'Sadakah', bn: '‡¶∏‡¶æ‡¶¶‡¶æ‡¶ï‡¶æ‡¶π' },
          totalFund: { en: 'Total Fund', bn: '‡¶´‡¶æ‡¶®‡ßç‡¶°‡ßá ‡¶Æ‡ßã‡¶ü ‡¶Ö‡¶∞‡ßç‡¶•' },

          // --- Notices ---
          noActivities: { en: 'No activities yet', bn: '‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶®‡ßá‡¶á' },
          postedBy: { en: 'Posted by', bn: '‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶ü‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®' },

          // --- Fund / History Section ---
          totalIncome: { en: 'Total Collection:', bn: '‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®' },
          totalExpense: { en: 'Total Sadakah:', bn: '‡¶Æ‡ßã‡¶ü ‡¶∏‡¶æ‡¶¶‡¶æ‡¶ï‡¶æ‡¶π' },
          monthlyBalance: { en: 'Monthly economy:', bn: '‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶á‡¶ï‡ßã‡¶®‡¶Æ‡¶ø' },
          netWorth: { en: 'Net worth at month end:', bn: '‡¶Æ‡¶æ‡¶∏ ‡¶∂‡ßá‡¶∑‡ßá ‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü ‡¶Ö‡¶∞‡ßç‡¶•:' },
          copyHistory: { en: '<img src="svgs/icon-copy.svg"> Copy', bn: '<img src="svgs/icon-copy.svg"> ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®' },
          noEntries: { en: 'No entries found', bn: '‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡ßá‡¶á' },
          noDonors: { en: 'No donors found', bn: '‡¶ï‡ßã‡¶®‡ßã ‡¶¶‡¶æ‡¶§‡¶æ ‡¶®‡ßá‡¶á' },
          noHistory: { en: 'No fund history available', bn: '‡¶´‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≠‡ßá‡¶á‡¶≤‡ßá‡¶¨‡¶≤ ‡¶®‡ßá‡¶á' },
          noIncomeEntries: { en: 'No Collection entries', bn: '‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡ßá‡¶á' },
          noExpenseEntries: { en: 'No Sadakah entries', bn: '‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡ßá‡¶á' },
          addDonorProfile: { en: '+ Add Donor Profile', bn: '+ ‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®' },

          // --- Settings ---
          bengaliMode: { en: 'Bengali Mode', bn: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®' },
          enable: { en: 'Enable', bn: '‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®' },
          talib: { en: 'Talib', bn: '‡¶§‡¶æ‡¶≤‡¶ø‡¶¨' },
          talibMenu: { en: 'Talib Menu', bn: '‡¶§‡¶æ‡¶≤‡¶ø‡¶¨ ‡¶Æ‡ßá‡¶®‡ßÅ' },
        };



        const updateLanguage = (isBn) => {
          document.querySelector('[data-section="fund"] div:last-child').textContent = isBn ? elementsToTranslate.fund.bn : elementsToTranslate.fund.en;
          document.querySelector('[data-section="notices"] div:last-child').textContent = isBn ? elementsToTranslate.notices.bn : elementsToTranslate.notices.en;
          document.querySelector('[data-section="blood"] div:last-child').textContent = isBn ? elementsToTranslate.blood.bn : elementsToTranslate.blood.en;
          document.getElementById('copyIncomeBtn').innerHTML = isBn ? '<img src="svgs/icon-copy.svg" style="display: inline;"> ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®' : '<img src="svgs/icon-copy.svg" style="display: inline;"> Copy List';
          document.getElementById('showYearlyChartBtn').innerHTML = isBn ? '<img src="svgs/overview-icon.svg" style="width: 20px; height: 20px; display: inline;"> ‡¶è‡¶á ‡¶¨‡¶õ‡¶∞‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£' : '<img src="svgs/overview-icon.svg" style="width: 20px; height: 20px; display: inline;"> View Yearly Overview';
          document.getElementById('copyHistoryBtn').innerHTML = isBn ? '<img src="svgs/icon-copy.svg" style="display: inline;"> ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®' : '<img src="svgs/icon-copy.svg" style="display: inline;"> Copy';
          appTitle.innerHTML = isBn ? '‡¶è‡¶∏‡ßã ‡¶Ö‡¶¨‡¶¶‡¶æ‡¶® ‡¶∞‡¶æ‡¶ñ‡¶ø<br><span class="text-sm opacity-90">Esho Obodan Rakhi</span>' : 'Esho Obodan Rakhi<br><span class="text-sm opacity-90">‡¶è‡¶∏‡ßã ‡¶Ö‡¶¨‡¶¶‡¶æ‡¶® ‡¶∞‡¶æ‡¶ñ‡¶ø</span>';

          // Fund History Section Headers
          document.querySelector('#fundSection h3.text-green-700').textContent = isBn ? elementsToTranslate.income.bn : elementsToTranslate.income.en;

          // Donation info text (collection view)
          const donationInfoText = document.getElementById('donationInfoText');
          if (donationInfoText) {
            donationInfoText.textContent = isBn ? '‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡¶æ‡¶¶‡¶æ‡¶ï‡¶æ‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶ø‡¶ì ‡¶Ö‡¶¨‡¶¶‡¶æ‡¶® ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡¶É' : 'You can also contribute by donating to:';
          }
          const donationNumbers = donationInfoText?.nextElementSibling?.querySelectorAll('div');
          if (donationNumbers && donationNumbers.length >= 2) {
            donationNumbers[0].innerHTML = isBn ? '<span class="underline">+880 1937-222273</span> - ‡¶®‡¶ó‡¶¶' : '<span class="underline">+880 1937-222273</span> - nogod';
            donationNumbers[1].innerHTML = isBn ? '<span class="underline">+880 1515-214867</span> - ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂' : '<span class="underline">+880 1515-214867</span> - bkash';
          }

          // Donation info text (sadakah list view)
          const sadakahDonationInfoText = document.getElementById('sadakahDonationInfoText');
          if (sadakahDonationInfoText) {
            sadakahDonationInfoText.textContent = isBn ? '‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡¶æ‡¶¶‡¶æ‡¶ï‡¶æ‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶ø‡¶ì ‡¶Ö‡¶¨‡¶¶‡¶æ‡¶® ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡¶É' : 'You can also contribute by donating to:';
          }
          const sadakahDonationNumbers = sadakahDonationInfoText?.nextElementSibling?.querySelectorAll('div');
          if (sadakahDonationNumbers && sadakahDonationNumbers.length >= 2) {
            sadakahDonationNumbers[0].innerHTML = isBn ? '<span class="underline">+880 1937-222273</span> - ‡¶®‡¶ó‡¶¶' : '<span class="underline">+880 1937-222273</span> - nogod';
            sadakahDonationNumbers[1].innerHTML = isBn ? '<span class="underline">+880 1515-214867</span> - ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂' : '<span class="underline">+880 1515-214867</span> - bkash';
          }
          document.querySelector('#fundSection h3.text-red-700').textContent = isBn ? elementsToTranslate.expense.bn : elementsToTranslate.expense.en;
          document.querySelector('#totalIncome').previousElementSibling.textContent = isBn ? elementsToTranslate.totalIncome.bn : elementsToTranslate.totalIncome.en;
          document.querySelector('#totalExpense').previousElementSibling.textContent = isBn ? elementsToTranslate.totalExpense.bn : elementsToTranslate.totalExpense.en;
          document.querySelector('#monthlyBalance').previousElementSibling.textContent = isBn ? elementsToTranslate.monthlyBalance.bn : elementsToTranslate.monthlyBalance.en;
          document.querySelector('#netWorth').previousElementSibling.textContent = isBn ? elementsToTranslate.netWorth.bn : elementsToTranslate.netWorth.en;

          // Activities Section
          document.querySelector('#noticesSection h2').textContent = isBn ? '‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶∏‡¶Æ‡ßÇ‡¶π' : 'Fund Activities';
          document.getElementById('postNoticeBtn').textContent = isBn ? elementsToTranslate.postActivity.bn : elementsToTranslate.postActivity.en;

          // Blood Donors Section
          document.querySelector('#bloodSection h2').textContent = isBn ? elementsToTranslate.blood.bn : elementsToTranslate.blood.en;
          const donorPrompt = document.getElementById('donorPromptMessage');
          if (donorPrompt) {
            donorPrompt.textContent = isBn ? '‡¶¨‡ßç‡¶≤‡¶æ‡¶° ‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø "‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤" ‡¶è ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶ì ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§' : 'To be a blood donor, click on "My Profile" and add your phone number and location.';
          }
          // Update My Profile button
          App.updateMyProfileButtonText();

          // Donor Profile Modal
          document.querySelector('#donorProfileModal h2').textContent = isBn ? elementsToTranslate.donorProfileModal.bn : elementsToTranslate.donorProfileModal.en;
          document.getElementById('donorName').placeholder = isBn ? elementsToTranslate.fullName.bn : elementsToTranslate.fullName.en;
          document.getElementById('donorPhone').placeholder = isBn ? elementsToTranslate.phoneNumber.bn : elementsToTranslate.phoneNumber.en;
          document.querySelector('#donorBloodGroup option[value=""]').textContent = isBn ? elementsToTranslate.bloodGroup.bn : elementsToTranslate.bloodGroup.en;
          document.getElementById('donorLocation').placeholder = isBn ? elementsToTranslate.location.bn : elementsToTranslate.location.en;
          document.querySelector('#donorProfileForm label span').textContent = isBn ? elementsToTranslate.available.bn : elementsToTranslate.available.en;
          
          // Last donated label
          const hasLastDonatedLabel = document.querySelector('#donorHasLastDonated').nextElementSibling;
          if (hasLastDonatedLabel) {
            hasLastDonatedLabel.textContent = isBn ? '‡¶Ü‡¶ó‡ßá ‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®' : 'Has donated before';
          }

          // Update highlight checkbox labels
          document.querySelector('#addIncomeForm label span').textContent = isBn ? '‡¶è‡¶á ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶π‡¶æ‡¶á‡¶≤‡¶æ‡¶á‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®' : 'Highlight this entry';
          document.querySelector('#addExpenseForm label span').textContent = isBn ? '‡¶è‡¶á ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶π‡¶æ‡¶á‡¶≤‡¶æ‡¶á‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®' : 'Highlight this entry';
          document.querySelector('#donorProfileForm button[type="submit"]').textContent = isBn ? elementsToTranslate.save.bn : elementsToTranslate.save.en;

          // Blood Filter
          document.querySelector('#bloodFilter option[value="all"]').textContent = isBn ? elementsToTranslate.allGroups.bn : elementsToTranslate.allGroups.en;
          document.getElementById('bloodSearch').placeholder = isBn ? '‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...' : 'Search donors...';
          document.getElementById('deleteDonorBtn').textContent = isBn ? elementsToTranslate.delete.bn : elementsToTranslate.delete.en;

          // Update donor availability text in rendered list
          App.filterAndRenderDonors();
          document.querySelector('#donorProfileModal [data-close-modal]').textContent = isBn ? elementsToTranslate.cancel.bn : elementsToTranslate.cancel.en;

          // Add Income/Expense Modals
          document.querySelector('#addIncomeModal h2').textContent = isBn ? '‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®' : 'Add Collection';
          document.getElementById('addIncomeBtn').textContent = isBn ? '+‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®' : '+Collection';
          document.getElementById('incomeName').placeholder = isBn ? '‡¶¶‡¶æ‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ' : 'Donor Name';
          document.getElementById('incomeAmount').placeholder = isBn ? '‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)' : 'Amount (‡ß≥)';
          document.querySelector('#addIncomeForm button[type="submit"]').textContent = isBn ? '‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®' : 'Add';
          document.querySelector('#addIncomeModal [data-close-modal]').textContent = isBn ? elementsToTranslate.cancel.bn : elementsToTranslate.cancel.en;

          document.querySelector('#addExpenseModal h2').textContent = isBn ? '‡¶∏‡¶æ‡¶¶‡¶æ‡¶ï‡¶æ‡¶π ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®' : 'Add Sadakah';
          document.getElementById('addExpenseBtn').textContent = isBn ? '+‡¶∏‡¶æ‡¶¶‡¶æ‡¶ï‡¶æ‡¶π' : '+Sadakah';
          document.getElementById('expenseDesc').placeholder = isBn ? '‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ' : 'Title';
          document.getElementById('expenseAmount').placeholder = isBn ? '‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)' : 'Amount (‡ß≥)';
          document.getElementById('expenseAdditionalInfo').placeholder = isBn ? '‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶§‡¶•‡ßç‡¶Ø (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)' : 'Additional info (optional)';

          // Fund tabs
          if (document.getElementById('collectionTabBtn')) {
            document.querySelector('#collectionTabBtn .text-sm').textContent = isBn ? '‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®' : 'Collection';
            const collectionMonth = document.getElementById('collectionTabMonth');
            if (collectionMonth) {
              const amount = collectionMonth.textContent.split(' ')[1];
              collectionMonth.textContent = isBn ? `‡ß≥ ${amount} ‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá` : `‡ß≥ ${amount} this month`;
            }
          }

          if (document.getElementById('sadakahTabBtn')) {
            document.querySelector('#sadakahTabBtn .text-sm').textContent = isBn ? '‡¶∏‡¶æ‡¶¶‡¶æ‡¶ï‡¶æ‡¶π' : 'Sadakah';
const sadakahCount = document.getElementById('sadakahTabCount');
if (sadakahCount) {
  const amount = sadakahCount.textContent.match(/‡ß≥\s*[\d,]+/)?.[0] || '‡ß≥ 0';
  sadakahCount.textContent = isBn ? `${amount} ‡¶´‡¶æ‡¶®‡ßç‡¶° ‡¶•‡ßá‡¶ï‡ßá` : `${amount} from fund`;
}
          }

          // Sadakah list view
          const sadakahListTitle = document.querySelector('#sadakahListView h3');
          if (sadakahListTitle) {
            sadakahListTitle.textContent = isBn ? '‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶æ‡¶¶‡¶æ‡¶ï‡¶æ‡¶π ‡¶è‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø' : 'All Sadakah History';
          }
          document.querySelector('#addExpenseForm button[type="submit"]').textContent = isBn ? '‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®' : 'Add';
          document.querySelector('#addExpenseModal [data-close-modal]').textContent = isBn ? elementsToTranslate.cancel.bn : elementsToTranslate.cancel.en;

          // Post Notice Modal (only update if not in edit mode)
          if (!document.getElementById('noticeId').value) {
            document.querySelector('#postNoticeModal h2').textContent = isBn ? elementsToTranslate.postNoticeModal.bn : elementsToTranslate.postNoticeModal.en;
            document.querySelector('#postNoticeForm button[type="submit"]').textContent = isBn ? '‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®' : 'Post';
          }
          document.getElementById('noticeText').placeholder = isBn ? '‡¶ï‡ßÄ ‡¶ò‡¶ü‡¶õ‡ßá?' : "What's happening?";
          document.querySelector('#postNoticeModal [data-close-modal]').textContent = isBn ? elementsToTranslate.cancel.bn : elementsToTranslate.cancel.en;

          // Yearly Chart Modal
          document.querySelector('#yearlyChartModal h2').textContent = isBn ? elementsToTranslate.yearlyChartModal.bn : elementsToTranslate.yearlyChartModal.en;
          document.querySelector('#yearlyChartModal [data-close-modal]').textContent = isBn ? elementsToTranslate.close.bn : elementsToTranslate.close.en;

          // Top Login Button
          document.getElementById('loginTopBtn').textContent = isBn ? elementsToTranslate.login.bn : elementsToTranslate.login.en;

          // Settings Modal
          document.querySelector('#settingsModal h2').textContent = isBn ? '‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏' : 'Settings';
          document.querySelector('#settingsModal .flex.items-center.justify-between span').textContent = isBn ? elementsToTranslate.bengaliMode.bn : elementsToTranslate.bengaliMode.en;
          document.querySelector('#settingsModal label span').textContent = isBn ? elementsToTranslate.enable.bn : elementsToTranslate.enable.en;
          document.getElementById('loginBtn').textContent = isBn ? elementsToTranslate.login.bn : elementsToTranslate.login.en;
          document.getElementById('logoutBtn').textContent = isBn ? elementsToTranslate.logout.bn : elementsToTranslate.logout.en;
          document.querySelector('#settingsModal [data-close-modal]').textContent = isBn ? elementsToTranslate.close.bn : elementsToTranslate.close.en;

          // Login Modal
          document.querySelector('#loginModal h2').textContent = isBn ? elementsToTranslate.loginModal.bn : elementsToTranslate.loginModal.en;
          document.getElementById('loginEmail').placeholder = isBn ? elementsToTranslate.email.bn : elementsToTranslate.email.en;
          document.getElementById('loginPassword').placeholder = isBn ? elementsToTranslate.password.bn : elementsToTranslate.password.en;
          document.querySelector('#loginForm button[type="submit"]').textContent = isBn ? elementsToTranslate.login.bn : elementsToTranslate.login.en;
          document.getElementById('showSignupBtn').textContent = isBn ? elementsToTranslate.dontHaveAccount.bn : elementsToTranslate.dontHaveAccount.en;
          document.querySelector('#loginModal [data-close-modal]').textContent = isBn ? elementsToTranslate.cancel.bn : elementsToTranslate.cancel.en;

          // Signup Modal
          document.querySelector('#signupModal h2').textContent = isBn ? elementsToTranslate.signupModal.bn : elementsToTranslate.signupModal.en;
          document.getElementById('signupName').placeholder = isBn ? elementsToTranslate.fullName.bn : elementsToTranslate.fullName.en;
          document.getElementById('signupEmail').placeholder = isBn ? elementsToTranslate.email.bn : elementsToTranslate.email.en;
          document.getElementById('signupPassword').placeholder = isBn ? elementsToTranslate.password.bn : elementsToTranslate.password.en;
          document.getElementById('signupConfirmPassword').placeholder = isBn ? elementsToTranslate.confirmPassword.bn : elementsToTranslate.confirmPassword.en;
          document.querySelector('#signupForm button[type="submit"]').textContent = isBn ? elementsToTranslate.signup.bn : elementsToTranslate.signup.en;
          document.getElementById('showLoginBtn').textContent = isBn ? elementsToTranslate.alreadyHaveAccount.bn : elementsToTranslate.alreadyHaveAccount.en;
          document.querySelector('#signupModal [data-close-modal]').textContent = isBn ? elementsToTranslate.cancel.bn : elementsToTranslate.cancel.en;

          // Forgot Password Modal
          document.getElementById('forgotPasswordBtn').textContent = isBn ? elementsToTranslate.forgotPassword.bn : elementsToTranslate.forgotPassword.en;
          document.querySelector('#forgotPasswordModal h2').textContent = isBn ? elementsToTranslate.forgotPasswordTitle.bn : elementsToTranslate.forgotPasswordTitle.en;
          document.querySelector('#forgotPasswordModal p').textContent = isBn ? elementsToTranslate.forgotPasswordDesc.bn : elementsToTranslate.forgotPasswordDesc.en;
          document.getElementById('forgotEmail').placeholder = isBn ? elementsToTranslate.email.bn : elementsToTranslate.email.en;
          document.querySelector('#forgotPasswordForm button[type="submit"]').textContent = isBn ? elementsToTranslate.sendResetLink.bn : elementsToTranslate.sendResetLink.en;
          document.getElementById('backToLoginBtn').textContent = isBn ? elementsToTranslate.backToLogin.bn : elementsToTranslate.backToLogin.en;
          document.querySelector('#forgotPasswordModal [data-close-modal]').textContent = isBn ? elementsToTranslate.cancel.bn : elementsToTranslate.cancel.en;

          // Complete History Modal
          document.querySelector('#completeHistoryModal [data-close-modal]').textContent = isBn ? elementsToTranslate.close.bn : elementsToTranslate.close.en;

          // User button and modal
          const userBtn = document.getElementById('userMenuBtn');
          if (userBtn) {
            userBtn.textContent = isBn ? '‡¶Æ‡ßá‡¶®‡ßÅ' : 'Menu';
          }
          const userMenuTitle = document.querySelector('#userMenuModal h2');
          if (userMenuTitle) {
            userMenuTitle.textContent = isBn ? '‡¶Æ‡ßá‡¶®‡ßÅ' : 'Menu';
          }
          const userNotesBtn = document.getElementById('userNotesBtn');
          if (userNotesBtn) {
            userNotesBtn.innerHTML = isBn ? 'üìù ‡¶®‡ßã‡¶ü' : 'üìù Notes';
          }
          const userNotifBtn = document.getElementById('userNotificationsBtn');
          if (userNotifBtn) {
            userNotifBtn.innerHTML = isBn ? 'üîî ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®' : 'üîî Notifications';
          }

          // Talib button and modal
          const talibBtn = document.getElementById('talibMenuBtn');
          if (talibBtn) {
            talibBtn.textContent = isBn ? '‡¶Æ‡ßá‡¶®‡ßÅ' : 'Menu';
          }
          const talibMenuTitle = document.querySelector('#talibMenuModal h2');
          if (talibMenuTitle) {
            talibMenuTitle.textContent = isBn ? '‡¶Æ‡ßá‡¶®‡ßÅ' : 'Menu';
          }

          // Admin Menu Modal
          const adminMenuTitle = document.querySelector('#adminMenuModal h2');
          if (adminMenuTitle) {
            adminMenuTitle.textContent = isBn ? '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Æ‡ßá‡¶®‡ßÅ' : 'Admin Menu';
          }
          const adminUsersBtn = document.getElementById('adminUsersBtn');
          if (adminUsersBtn) {
            adminUsersBtn.innerHTML = isBn ? 'üë• ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶∏' : 'üë• Users';
          }
          // Notes section buttons - update tooltips only
          const exportNotesBtn = document.getElementById('exportNotesBtn');
          if (exportNotesBtn) {
            exportNotesBtn.title = isBn ? '‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®' : 'Export to File';
          }

          const importNotesBtn = document.getElementById('importNotesBtn');
          if (importNotesBtn) {
            importNotesBtn.title = isBn ? '‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®' : 'Import from File';
          }

          const createBackupBtn = document.getElementById('createBackupBtn');
          if (createBackupBtn) {
            createBackupBtn.title = isBn ? '‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶°‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™' : 'Backup to Cloud';
          }

          const createNoteBtn = document.getElementById('createNoteBtn');
          if (createNoteBtn) {
            createNoteBtn.title = isBn ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡ßã‡¶ü' : 'New Note';
          }

          // Admin Users Modal
          const adminUsersTitle = document.querySelector('#adminUsersModal h2');
          if (adminUsersTitle) {
            adminUsersTitle.textContent = isBn ? '‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü' : 'Manage Users';
          }

          // Notifications
          const notificationsTitle = document.querySelector('#notificationsSection h2');
          if (notificationsTitle) {
            notificationsTitle.textContent = isBn ? '‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®' : 'Notifications';
          }
          const createNotifBtn = document.getElementById('createNotificationBtn');
          if (createNotifBtn) {
            createNotifBtn.textContent = isBn ? '+ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®' : '+ New Notification';
          }
          const talibNotifBtn = document.getElementById('talibNotificationsBtn');
          if (talibNotifBtn) {
            talibNotifBtn.innerHTML = isBn ? 'üîî ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®' : 'üîî Notifications';
          }
          const talibMessageBtn = document.getElementById('talibMessageAdminBtn');
          if (talibMessageBtn) {
            talibMessageBtn.innerHTML = isBn ? 'üí¨ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡¶ï‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®<span id="talibMessageAdminBadge" class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full hide"></span>' : 'üí¨ Message Admin<span id="talibMessageAdminBadge" class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full hide"></span>';
          }
          const adminNotifBtn = document.getElementById('adminNotificationsBtn');
          if (adminNotifBtn) {
            adminNotifBtn.innerHTML = isBn ? 'üîî ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®' : 'üîî Notifications';
          }

          // Role Confirmation Modals
          const roleConfirmTitle = document.querySelector('#roleConfirmModal h2');
          if (roleConfirmTitle) {
            roleConfirmTitle.textContent = isBn ? '‡¶∞‡ßã‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®' : 'Confirm Role Change';
          }
          const roleConfirmText = document.querySelector('#roleConfirmModal p');
          if (roleConfirmText) {
            roleConfirmText.textContent = isBn ? '‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∞‡ßã‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?' : 'Are you sure you want to change this user\'s role?';
          }

          const roleConsequencesTitle = document.querySelector('#roleConsequencesModal h2');
          if (roleConsequencesTitle) {
            roleConsequencesTitle.textContent = isBn ? '‚ö†Ô∏è ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£: ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¨‡ßÅ‡¶ù‡ßÅ‡¶®' : '‚ö†Ô∏è Important: Understand the Consequences';
          }
        };

        const savedLang = localStorage.getItem('lang') || 'en';
        const isBn = savedLang === 'bn';
        toggle.checked = isBn;
        updateLanguage(isBn);


                toggle.addEventListener('change', () => {
          const newLang = toggle.checked ? 'bn' : 'en';
          localStorage.setItem('lang', newLang);
          updateLanguage(toggle.checked);
        });
      },

      setupMobileBackHandler() {
        // Handle back button on mobile devices
        if (typeof window.Capacitor !== 'undefined' && window.Capacitor.isNativePlatform?.()) {
          const { App: CapApp } = window.Capacitor.Plugins;
          
          CapApp.addListener('backButton', () => {
            // Check if any modal is open
            const openModal = document.querySelector('.modal:not(.hide)');
            
            if (openModal) {
              // Close the modal instead of exiting app
              this.hideAllModals();
            } else {
              // No modal open - allow default back behavior (exit app)
              CapApp.exitApp();
            }
          });
        } else {
          // For web: handle browser back button
          window.addEventListener('popstate', (event) => {
            const openModal = document.querySelector('.modal:not(.hide)');
            
            if (openModal) {
              event.preventDefault();
              this.hideAllModals();
              // Push state back so we don't navigate away
              history.pushState(null, '', window.location.href);
            }
          });
          
          // Initial state push for web
          history.pushState(null, '', window.location.href);
        }
      }
    };

    
    
    // Start the application once the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => App.init());
  </script>
  <script id="activities" src="js/activities.js"></script>
  <script id="notes" src="js/notes.js"></script>
  <script id="blood" src="js/blood.js"></script>
  <script id="auth" src="js/auth.js"></script>
  <script id="fund" src="js/fund.js"></script>
  <script id="notifications" src="js/notifications.js"></script>
  <script id="messages" src="js/messages.js"></script>
</body>

</html>

<!--
We are really sorry that¬†we had to remove your blood donor profile.
This is a organization for our brothers from deen, brothers from islam. Here having a female blood donor account can raise many controversies.

Also, your name and your phone number is public, for most men it is not a big deal. But for a woman it can lead to data leak and harassment and we really do not want any of it happening, and more importantly we don't wanna be a medium for it.
Hope you understand. Thank you anyways for considering to create a blood donor account and leave your contribution to the society.
-->